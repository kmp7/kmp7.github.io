.<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>kmp+</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --success: #27ae60;
            --warning: #f39c12;
            --light: #ecf0f1;
            --dark: #1a252f;
            --panel-bg: #f8f9fa;
            --border: #dee2e6;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Roboto', 'Ubuntu', sans-serif;
        min-height: 100vh;
            color: var(--primary);
        }

        /* –®–∞–ø–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è */
        .app-header {
            background: var(--dark);
            color: white;
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
        }

        .app-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .app-title h1 {
            font-size: 1.4rem;
            font-weight: 600;
        }

        .app-title .subtitle {
            font-size: 0.85rem;
            opacity: 0.8;
            border-left: 1px solid rgba(255,255,255,0.3);
            padding-left: 12px;
        }

        .logo {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--secondary), var(--success));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--secondary);
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #219a52;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-danger {
            background: var(--accent);
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
        }

        .btn-outline:hover {
            background: rgba(255,255,255,0.1);
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
        .main-container {
            display: grid;
            grid-template-columns: 260px 1fr 300px;
            height: calc(100vh - 60px);
            gap: 0;
        }

        /* –ü–∞–Ω–µ–ª–∏ */
        .panel {
            background: var(--panel-bg);
            overflow-y: auto;
        }

        .panel-header {
            background: var(--primary);
            color: white;
            padding: 14px 16px;
            font-weight: 600;
            font-size: 0.95rem;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .panel-content {
            padding: 16px;
        }

        /* –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å - –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã */
        .tools-panel {
            border-right: 1px solid var(--border);
        }

        .tool-section {
            margin-bottom: 20px;
        }

        .tool-section-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #7f8c8d;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .tool-btn {
            width: 100%;
            padding: 12px 14px;
            margin-bottom: 8px;
            background: white;
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s ease;
            text-align: left;
        }

        .tool-btn:hover {
            border-color: var(--secondary);
            background: #e8f4fc;
            transform: translateX(4px);
        }

        .tool-btn.active {
            border-color: var(--secondary);
            background: var(--secondary);
            color: white;
        }

        .tool-btn.active .tool-icon {
            background: white;
            color: var(--secondary);
        }

        .tool-icon {
            width: 36px;
            height: 28px;
            background: var(--light);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            flex-shrink: 0;
        }

        .tool-icon.icon-start {
            border-radius: 14px;
            background: var(--success);
            color: white;
        }

        .tool-icon.icon-end {
            border-radius: 14px;
            background: var(--accent);
            color: white;
        }

        .tool-icon.icon-action {
            background: var(--secondary);
            color: white;
        }

        .tool-icon.icon-question {
            background: var(--warning);
            color: white;
            clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
            width: 32px;
            height: 32px;
        }

        .tool-icon.icon-input {
            background: #9b59b6;
            color: white;
            transform: skewX(-10deg);
        }

        .tool-icon.icon-output {
            background: #1abc9c;
            color: white;
            transform: skewX(10deg);
        }

        .tool-icon.icon-comment {
            background: #95a5a6;
            color: white;
            border-left: 3px solid var(--primary);
        }

        .tool-icon.icon-insert {
            background: #e67e22;
            color: white;
            border-left: 3px double white;
            border-right: 3px double white;
        }

        .tool-info {
            flex: 1;
        }

        .tool-name {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 2px;
        }

        .tool-desc {
            font-size: 0.75rem;
            color: #7f8c8d;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        /* –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –æ–±–ª–∞—Å—Ç—å - –•–æ–ª—Å—Ç */
        .canvas-area {
            background: white;
            position: relative;
            overflow: hidden;
        }

        .canvas-toolbar {
            position: absolute;
            top: 12px;
            left: 12px;
            right: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            pointer-events: none;
        }

        .canvas-toolbar > * {
            pointer-events: all;
        }

        .zoom-controls {
            display: flex;
            gap: 4px;
            background: white;
            padding: 4px;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }

        .zoom-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--light);
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .zoom-btn:hover {
            background: var(--secondary);
            color: white;
        }

        .zoom-level {
            padding: 0 12px;
            display: flex;
            align-items: center;
            font-size: 0.85rem;
            color: var(--primary);
        }

        .canvas-info {
            background: white;
            padding: 8px 14px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            font-size: 0.85rem;
            color: var(--primary);
        }

        #canvas-container {
            width: 100%;
            height: 100%;
            overflow: auto;
            background: 
                linear-gradient(90deg, #f0f0f0 1px, transparent 1px),
                linear-gradient(#f0f0f0 1px, transparent 1px);
            background-size: 20px 20px;
            background-position: -1px -1px;
        }

        #main-canvas {
            min-width: 2000px;
            min-height: 1500px;
            cursor: crosshair;
        }

        /* –≠–ª–µ–º–µ–Ω—Ç—ã –î–†–ê–ö–û–ù –Ω–∞ —Ö–æ–ª—Å—Ç–µ */
        .drakon-element {
            cursor: move;
            user-select: none;
        }

        .drakon-element:hover .element-shape {
            filter: brightness(1.05);
        }

        .drakon-element.selected .element-shape {
            stroke: var(--secondary);
            stroke-width: 3;
            filter: drop-shadow(0 0 8px rgba(52, 152, 219, 0.5));
        }

        .element-text {
            pointer-events: none;
            font-family: 'Segoe UI', sans-serif;
            font-size: 13px;
            fill: var(--primary);
        }

        .connection-line {
            stroke: var(--primary);
            stroke-width: 2;
            fill: none;
            marker-end: url(#arrowhead);
        }

        .connection-line:hover {
            stroke: var(--accent);
            stroke-width: 3;
        }

        .connection-label {
            font-size: 11px;
            fill: var(--primary);
            font-weight: 600;
        }

        /* –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å - –°–ø—Ä–∞–≤–∫–∞ */
        .help-panel {
            border-left: 1px solid var(--border);
        }

        .help-section {
            margin-bottom: 24px;
        }

        .help-section-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--secondary);
        }

        .help-text {
            font-size: 0.85rem;
            line-height: 1.6;
            color: #555;
        }

        .help-list {
            list-style: none;
            font-size: 0.85rem;
        }

        .help-list li {
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .help-list li:last-child {
            border-bottom: none;
        }

        .help-key {
            background: var(--light);
            padding: 2px 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .task-box {
            background: linear-gradient(135deg, #e8f4fc, #f0e6fa);
            border: 2px solid var(--secondary);
            border-radius: 10px;
            padding: 16px;
        }

        .task-title {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .task-badge {
            background: var(--secondary);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
        }

        .task-description {
            font-size: 0.85rem;
            line-height: 1.6;
            color: #555;
        }

        .task-steps {
            margin-top: 12px;
            padding-left: 20px;
        }

        .task-steps li {
            font-size: 0.85rem;
            margin-bottom: 6px;
            color: #555;
        }

        .linguistic-note {
            background: #fff3cd;
            border-left: 4px solid var(--warning);
            padding: 12px;
            border-radius: 0 8px 8px 0;
            margin-top: 16px;
        }

        .linguistic-note-title {
            font-weight: 600;
            font-size: 0.85rem;
            color: #856404;
            margin-bottom: 6px;
        }

        .linguistic-note-text {
            font-size: 0.8rem;
            color: #856404;
            line-height: 1.5;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 12px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--accent);
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--primary);
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 0.95rem;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--secondary);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é */
        .context-menu {
            position: fixed;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            min-width: 180px;
            z-index: 1000;
            display: none;
            overflow: hidden;
        }

        .context-menu.active {
            display: block;
        }

        .context-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            transition: background 0.15s;
        }

        .context-menu-item:hover {
            background: var(--light);
        }

        .context-menu-item.danger {
            color: var(--accent);
        }

        .context-menu-divider {
            height: 1px;
            background: var(--border);
            margin: 4px 0;
        }

        /* –°—Ç–∞—Ç—É—Å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ */
        .status-bar {
            position: absolute;
            bottom: 12px;
            left: 12px;
            background: white;
            padding: 8px 14px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .drakon-element {
            animation: fadeIn 0.3s ease;
        }

        /* –†–µ–∂–∏–º —Å–≤—è–∑—ã–≤–∞–Ω–∏—è */
        .canvas-area.connecting-mode {
            cursor: crosshair;
        }

        .canvas-area.connecting-mode #main-canvas {
            cursor: crosshair;
        }

        .connection-preview {
            stroke: var(--secondary);
            stroke-width: 2;
            stroke-dasharray: 5,5;
            fill: none;
            pointer-events: none;
        }

        /* –ü–æ–¥—Å–∫–∞–∑–∫–∏ */
        .tooltip {
            position: fixed;
            background: var(--dark);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            pointer-events: none;
            z-index: 1001;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .tooltip.active {
            opacity: 1;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 220px 1fr 260px;
            }
        }

        @media (max-width: 992px) {
            .main-container {
                grid-template-columns: 200px 1fr;
            }
            .help-panel {
                display: none;
            }
        }
		.footer {
            text-align: center;
            padding: 30px;
            color: var(--text-light);
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <!-- –®–∞–ø–∫–∞ -->
    <header class="app-header">
        <div class="app-title">
        <h1>–†–µ–¥–∞–∫—Ç–æ—Ä –î–†–ê–ö–û–ù</h1>
            <span class="subtitle">–í–∏–∑—É–∞–ª—å–Ω–æ–µ –∞–ª–≥–æ—Ä–∏—Ç–º–∏—á–µ—Å–∫–æ–µ –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ</span>
        </div>
        <div class="header-actions">
            <button class="btn btn-outline" onclick="showHelp()">
                <span></span> –°–ø—Ä–∞–≤–∫–∞
            </button>
            <button class="btn btn-success" onclick="exportSVG()">
                <span></span> –≠–∫—Å–ø–æ—Ä—Ç SVG
            </button>
            <button class="btn btn-primary" onclick="exportPNG()">
                <span></span> –≠–∫—Å–ø–æ—Ä—Ç PNG
            </button>
        </div>
    </header>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
    <div class="main-container">
        <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å - –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã -->
        <aside class="panel tools-panel">
            <div class="panel-header">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –î–†–ê–ö–û–ù</div>
            <div class="panel-content">
                <div class="tool-section">
                    <div class="tool-section-title">–ë–∞–∑–æ–≤—ã–µ –∏–∫–æ–Ω—ã</div>
                    
                    <button class="tool-btn" data-type="start" onclick="selectTool('start')">
                        <div class="tool-icon icon-start">‚ñ∂</div>
                        <div class="tool-info">
                            <div class="tool-name">–ó–∞–≥–æ–ª–æ–≤–æ–∫</div>
                            <div class="tool-desc">–ù–∞—á–∞–ª–æ –∞–ª–≥–æ—Ä–∏—Ç–º–∞</div>
                        </div>
                    </button>

                    <button class="tool-btn" data-type="end" onclick="selectTool('end')">
                        <div class="tool-icon icon-end">‚ñ†</div>
                        <div class="tool-info">
                            <div class="tool-name">–ö–æ–Ω–µ—Ü</div>
                            <div class="tool-desc">–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∞–ª–≥–æ—Ä–∏—Ç–º–∞</div>
                        </div>
                    </button>

                    <button class="tool-btn" data-type="action" onclick="selectTool('action')">
                        <div class="tool-icon icon-action"></div>
                        <div class="tool-info">
                            <div class="tool-name">–î–µ–π—Å—Ç–≤–∏–µ</div>
                            <div class="tool-desc">–û–ø–µ—Ä–∞—Ü–∏—è, –∫–æ–º–∞–Ω–¥–∞</div>
                        </div>
                    </button>

                    <button class="tool-btn" data-type="question" onclick="selectTool('question')">
                        <div class="tool-icon icon-question">?</div>
                        <div class="tool-info">
                            <div class="tool-name">–í–æ–ø—Ä–æ—Å</div>
                            <div class="tool-desc">–£—Å–ª–æ–≤–∏–µ (–î–∞/–ù–µ—Ç)</div>
                        </div>
                    </button>

                    <button class="tool-btn" data-type="input" onclick="selectTool('input')">
                        <div class="tool-icon icon-input">‚Üí</div>
                        <div class="tool-info">
                            <div class="tool-name">–í–≤–æ–¥</div>
                            <div class="tool-desc">–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö</div>
                        </div>
                    </button>

                    <button class="tool-btn" data-type="output" onclick="selectTool('output')">
                        <div class="tool-icon icon-output">‚Üê</div>
                        <div class="tool-info">
                            <div class="tool-name">–í—ã–≤–æ–¥</div>
                            <div class="tool-desc">–í—ã–¥–∞—á–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞</div>
                        </div>
                    </button>
                </div>

                <div class="tool-section">
                    <div class="tool-section-title">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ</div>

                    <button class="tool-btn" data-type="insert" onclick="selectTool('insert')">
                        <div class="tool-icon icon-insert"></div>
                        <div class="tool-info">
                            <div class="tool-name">–í—Å—Ç–∞–≤–∫–∞</div>
                            <div class="tool-desc">–í—ã–∑–æ–≤ –ø–æ–¥–ø—Ä–æ–≥—Ä–∞–º–º—ã</div>
                        </div>
                    </button>

                    <button class="tool-btn" data-type="comment" onclick="selectTool('comment')">
                        <div class="tool-icon icon-comment"></div>
                        <div class="tool-info">
                            <div class="tool-name">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</div>
                            <div class="tool-desc">–ü–æ—è—Å–Ω–µ–Ω–∏–µ</div>
                        </div>
                    </button>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="startConnecting()">
                        <span>üîó</span> –°–≤—è–∑–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã
                    </button>
                    <button class="btn btn-warning" onclick="clearCanvas()">
                        <span>üóëÔ∏è</span> –û—á–∏—Å—Ç–∏—Ç—å —Ö–æ–ª—Å—Ç
                    </button>
                    <button class="btn btn-outline" style="background: var(--light); color: var(--primary);" onclick="loadExample()">
                        <span>üìã</span> –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∏–º–µ—Ä
                    </button>
                </div>
            </div>
        </aside>

        <!-- –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –æ–±–ª–∞—Å—Ç—å - –•–æ–ª—Å—Ç -->
        <main class="canvas-area" id="canvas-area">
            <div class="canvas-toolbar">
                <div class="zoom-controls">
                    <button class="zoom-btn" onclick="zoomOut()">‚àí</button>
                    <span class="zoom-level" id="zoom-level">100%</span>
                    <button class="zoom-btn" onclick="zoomIn()">+</button>
                    <button class="zoom-btn" onclick="resetZoom()">‚Ü∫</button>
                </div>
                <div class="canvas-info" id="canvas-info">
                    –í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —Ö–æ–ª—Å—Ç
                </div>
            </div>

            <div id="canvas-container">
                <svg id="main-canvas" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <!-- –°—Ç—Ä–µ–ª–∫–∞ –¥–ª—è —Å–æ–µ–¥–∏–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ª–∏–Ω–∏–π -->
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                                refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#2c3e50"/>
                        </marker>
                        <marker id="arrowhead-hover" markerWidth="10" markerHeight="7" 
                                refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#e74c3c"/>
                        </marker>
                        <!-- –ì—Ä–∞–¥–∏–µ–Ω—Ç—ã –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ -->
                        <linearGradient id="grad-start" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#2ecc71;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#27ae60;stop-opacity:1" />
                        </linearGradient>
                        <linearGradient id="grad-end" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#e74c3c;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#c0392b;stop-opacity:1" />
                        </linearGradient>
                        <linearGradient id="grad-action" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#3498db;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#2980b9;stop-opacity:1" />
                        </linearGradient>
                        <linearGradient id="grad-question" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#f39c12;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#e67e22;stop-opacity:1" />
                        </linearGradient>
                        <linearGradient id="grad-input" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#9b59b6;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#8e44ad;stop-opacity:1" />
                        </linearGradient>
                        <linearGradient id="grad-output" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#1abc9c;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#16a085;stop-opacity:1" />
                        </linearGradient>
                        <linearGradient id="grad-insert" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#e67e22;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#d35400;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    
                    <!-- –ì—Ä—É–ø–ø–∞ –¥–ª—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π (—Ä–∏—Å—É–µ—Ç—Å—è –ø–æ–¥ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏) -->
                    <g id="connections-layer"></g>
                    
                    <!-- –ì—Ä—É–ø–ø–∞ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ -->
                    <g id="elements-layer"></g>
                    
                    <!-- –ü—Ä–µ–≤—å—é —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è -->
                    <path id="connection-preview" class="connection-preview" d="" style="display:none;"/>
                </svg>
            </div>

            <div class="status-bar">
                <div class="status-item">
                    <span class="status-dot"></span>
                    <span>–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</span>
                </div>
                <div class="status-item" id="element-count">
                    –≠–ª–µ–º–µ–Ω—Ç–æ–≤: 0
                </div>
                <div class="status-item" id="connection-count">
                    –°–≤—è–∑–µ–π: 0
                </div>
            </div>
        </main>

        <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å - –°–ø—Ä–∞–≤–∫–∞ -->
        <aside class="panel help-panel">
            <div class="panel-header">–°–ø—Ä–∞–≤–∫–∞ –∏ –∑–∞–¥–∞–Ω–∏—è</div>
            <div class="panel-content">
                <div class="help-section">
                    <div class="task-box">
                        <div class="task-title">
                            <span>–£—á–µ–±–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ</span>
                                                   </div>
                        <div class="task-description">
                            –°–æ–∑–¥–∞–π—Ç–µ –î–†–ê–ö–û–ù-—Å—Ö–µ–º—É –∞–ª–≥–æ—Ä–∏—Ç–º–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –Ω–∞ –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω–æ–º —è–∑—ã–∫–µ:
                        </div>
                        <ol class="task-steps">
                            <li>–î–æ–±–∞–≤—å—Ç–µ –±–ª–æ–∫ ¬´–ó–∞–≥–æ–ª–æ–≤–æ–∫¬ª —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º</li>
                            <li>–°–æ–∑–¥–∞–π—Ç–µ –±–ª–æ–∫ ¬´–í–≤–æ–¥¬ª –¥–ª—è –≤—ã–±–æ—Ä–∞ —è–∑—ã–∫–∞</li>
                            <li>–î–æ–±–∞–≤—å—Ç–µ ¬´–í–æ–ø—Ä–æ—Å¬ª –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —è–∑—ã–∫–∞</li>
                            <li>–°–æ–∑–¥–∞–π—Ç–µ –±–ª–æ–∫–∏ ¬´–í—ã–≤–æ–¥¬ª –¥–ª—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π</li>
                            <li>–ó–∞–≤–µ—Ä—à–∏—Ç–µ –±–ª–æ–∫–æ–º ¬´–ö–æ–Ω–µ—Ü¬ª</li>
                            <li>–°–æ–µ–¥–∏–Ω–∏—Ç–µ –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å—Ç—Ä–µ–ª–∫–∞–º–∏</li>
                        </ol>
                    </div>
                </div>

                <div class="help-section">
                    <div class="help-section-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
                    <ul class="help-list">
                        <li>
                            <span class="help-key">–ö–ª–∏–∫</span>
                            <span>–î–æ–±–∞–≤–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç / –í—ã–±—Ä–∞—Ç—å</span>
                        </li>
                        <li>
                            <span class="help-key">–î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫</span>
                            <span>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç</span>
                        </li>
                        <li>
                            <span class="help-key">–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ</span>
                            <span>–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç</span>
                        </li>
                        <li>
                            <span class="help-key">Delete</span>
                            <span>–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ</span>
                        </li>
                        <li>
                            <span class="help-key">Esc</span>
                            <span>–û—Ç–º–µ–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ</span>
                        </li>
                        <li>
                            <span class="help-key">–ü–ö–ú</span>
                            <span>–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é</span>
                        </li>
                    </ul>
                </div>

                <div class="help-section">
                    <div class="help-section-title">–≠–ª–µ–º–µ–Ω—Ç—ã –î–†–ê–ö–û–ù</div>
                    <p class="help-text">
                        <strong>–ó–∞–≥–æ–ª–æ–≤–æ–∫</strong> ‚Äî –∏–º—è –∞–ª–≥–æ—Ä–∏—Ç–º–∞ (–∫–∞–∫ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞).<br><br>
                        <strong>–î–µ–π—Å—Ç–≤–∏–µ</strong> ‚Äî –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è (–∫–∞–∫ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ-–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è).<br><br>
                        <strong>–í–æ–ø—Ä–æ—Å</strong> ‚Äî —Ç–æ—á–∫–∞ –≤–µ—Ç–≤–ª–µ–Ω–∏—è (–∫–∞–∫ –≤—ã–±–æ—Ä –≤ –¥–∏–∞–ª–æ–≥–µ).<br><br>
                        <strong>–í–≤–æ–¥/–í—ã–≤–æ–¥</strong> ‚Äî –æ–±–º–µ–Ω –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π (–∫–∞–∫ —Ä–µ—Ü–µ–ø—Ü–∏—è –∏ –ø—Ä–æ–¥—É–∫—Ü–∏—è —Ä–µ—á–∏).
                    </p>
                </div>

                <div class="linguistic-note">
                    <div class="linguistic-note-title">üí° –°–≤—è–∑—å —Å –ª–∏–Ω–≥–≤–∏—Å—Ç–∏–∫–æ–π</div>
                    <div class="linguistic-note-text">
                        –î–†–ê–ö–û–ù-—Å—Ö–µ–º—ã –ø–æ–¥–æ–±–Ω—ã —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–º –¥–µ—Ä–µ–≤—å—è–º: —ç–ª–µ–º–µ–Ω—Ç—ã ‚Äî —ç—Ç–æ ¬´—É–∑–ª—ã¬ª, 
                        –∞ —Å–≤—è–∑–∏ ‚Äî ¬´–≤–µ—Ç–≤–∏¬ª. –ê–ª–≥–æ—Ä–∏—Ç–º —á–∏—Ç–∞–µ—Ç—Å—è —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑, –∫–∞–∫ —Ç–µ–∫—Å—Ç, 
                        —Å–ª–µ–¥—É—è –ø—Ä–∏–Ω—Ü–∏–ø—É ¬´—á–µ–º –ø—Ä–∞–≤–µ–µ ‚Äî —Ç–µ–º —Ö—É–∂–µ¬ª –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏–π.
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title" id="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞</span>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">–¢–µ–∫—Å—Ç —ç–ª–µ–º–µ–Ω—Ç–∞</label>
                    <textarea class="form-input form-textarea" id="element-text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç..."></textarea>
                </div>
                <div class="form-group" id="yes-label-group" style="display:none;">
                    <label class="form-label">–ù–∞–¥–ø–∏—Å—å ¬´–î–∞¬ª (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                    <input type="text" class="form-input" id="yes-label" placeholder="–î–∞">
                </div>
                <div class="form-group" id="no-label-group" style="display:none;">
                    <label class="form-label">–ù–∞–¥–ø–∏—Å—å ¬´–ù–µ—Ç¬ª (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                    <input type="text" class="form-input" id="no-label" placeholder="–ù–µ—Ç">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" style="background:#eee;color:#333;" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" onclick="saveElement()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é -->
    <div class="context-menu" id="context-menu">
        <div class="context-menu-item" onclick="editSelectedElement()">
            <span>‚úèÔ∏è</span> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
        </div>
        <div class="context-menu-item" onclick="duplicateElement()">
            <span>üìã</span> –î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="bringToFront()">
            <span>‚¨ÜÔ∏è</span> –ù–∞ –ø–µ—Ä–µ–¥–Ω–∏–π –ø–ª–∞–Ω
        </div>
        <div class="context-menu-item" onclick="sendToBack()">
            <span>‚¨áÔ∏è</span> –ù–∞ –∑–∞–¥–Ω–∏–π –ø–ª–∞–Ω
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item danger" onclick="deleteSelected()">
            <span>üóëÔ∏è</span> –£–¥–∞–ª–∏—Ç—å
        </div>
    </div>
<footer class="footer">
<div class="container">
<p>¬© 2026 | kmp | CC BY-NC-SA 4.0<br>
–¥–ª—è –≤—Å–µ—Ö</p>
</div>
</footer>
<div style="position: fixed; bottom: 10px; color: #777777; right: 30px; opacity: 0.3; font-size: 14px;">kmp+</div>
    <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ -->
    <div class="tooltip" id="tooltip"></div>

    <script>
        // ==================== –°–û–°–¢–û–Ø–ù–ò–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ====================
        const state = {
            elements: [],           // –ú–∞—Å—Å–∏–≤ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–∏–∞–≥—Ä–∞–º–º—ã
            connections: [],        // –ú–∞—Å—Å–∏–≤ —Å–≤—è–∑–µ–π
            selectedTool: null,     // –¢–µ–∫—É—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç
            selectedElement: null,  // –¢–µ–∫—É—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
            editingElement: null,   // –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π —ç–ª–µ–º–µ–Ω—Ç
            isConnecting: false,    // –†–µ–∂–∏–º —Å–æ–∑–¥–∞–Ω–∏—è —Å–≤—è–∑–∏
            connectionStart: null,  // –ù–∞—á–∞–ª—å–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç —Å–≤—è–∑–∏
            isDragging: false,      // –§–ª–∞–≥ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
            dragOffset: { x: 0, y: 0 },
            zoom: 1,
            nextId: 1
        };

        // ==================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –≠–õ–ï–ú–ï–ù–¢–û–í ====================
        const elementConfig = {
            start: {
                width: 140,
                height: 50,
                defaultText: '–ê–ª–≥–æ—Ä–∏—Ç–º',
                shape: 'rounded-rect',
                gradient: 'url(#grad-start)',
                textColor: 'white'
            },
            end: {
                width: 140,
                height: 50,
                defaultText: '–ö–æ–Ω–µ—Ü',
                shape: 'rounded-rect',
                gradient: 'url(#grad-end)',
                textColor: 'white'
            },
            action: {
                width: 160,
                height: 50,
                defaultText: '–î–µ–π—Å—Ç–≤–∏–µ',
                shape: 'rect',
                gradient: 'url(#grad-action)',
                textColor: 'white'
            },
            question: {
                width: 140,
                height: 80,
                defaultText: '–£—Å–ª–æ–≤–∏–µ?',
                shape: 'diamond',
                gradient: 'url(#grad-question)',
                textColor: 'white',
                hasYesNo: true
            },
            input: {
                width: 160,
                height: 50,
                defaultText: '–í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö',
                shape: 'parallelogram-right',
                gradient: 'url(#grad-input)',
                textColor: 'white'
            },
            output: {
                width: 160,
                height: 50,
                defaultText: '–í—ã–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö',
                shape: 'parallelogram-left',
                gradient: 'url(#grad-output)',
                textColor: 'white'
            },
            insert: {
                width: 160,
                height: 50,
                defaultText: '–ü–æ–¥–ø—Ä–æ–≥—Ä–∞–º–º–∞',
                shape: 'insert-rect',
                gradient: 'url(#grad-insert)',
                textColor: 'white'
            },
            comment: {
                width: 160,
                height: 60,
                defaultText: '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π',
                shape: 'comment',
                gradient: '#f8f9fa',
                textColor: '#2c3e50',
                stroke: '#95a5a6'
            }
        };

        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        const canvas = document.getElementById('main-canvas');
        const elementsLayer = document.getElementById('elements-layer');
        const connectionsLayer = document.getElementById('connections-layer');
        const canvasContainer = document.getElementById('canvas-container');
        const canvasArea = document.getElementById('canvas-area');

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π —Ö–æ–ª—Å—Ç–∞
        canvas.addEventListener('click', handleCanvasClick);
        canvas.addEventListener('mousemove', handleCanvasMouseMove);
        canvas.addEventListener('contextmenu', handleContextMenu);

        // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞
        document.addEventListener('keydown', handleKeyDown);

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.context-menu')) {
                document.getElementById('context-menu').classList.remove('active');
            }
        });

        // ==================== –§–£–ù–ö–¶–ò–ò –ò–ù–°–¢–†–£–ú–ï–ù–¢–û–í ====================
        function selectTool(type) {
            state.selectedTool = type;
            state.isConnecting = false;
            state.connectionStart = null;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.type === type) {
                    btn.classList.add('active');
                }
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
            const config = elementConfig[type];
            updateCanvasInfo(`–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —Ö–æ–ª—Å—Ç, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å: ${config.defaultText}`);
            
            canvasArea.classList.remove('connecting-mode');
        }

        function startConnecting() {
            state.isConnecting = true;
            state.connectionStart = null;
            state.selectedTool = null;
            
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            updateCanvasInfo('–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –ø–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–≤—è–∑–∏');
            canvasArea.classList.add('connecting-mode');
        }

        // ==================== –û–ë–†–ê–ë–û–¢–ö–ê –•–û–õ–°–¢–ê ====================
        function handleCanvasClick(e) {
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left + canvasContainer.scrollLeft) / state.zoom;
            const y = (e.clientY - rect.top + canvasContainer.scrollTop) / state.zoom;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–ª–∏–∫–Ω—É–ª–∏ –ª–∏ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç
            const clickedElement = getElementAtPosition(x, y);

            if (state.isConnecting) {
                handleConnectionClick(clickedElement);
            } else if (state.selectedTool && !clickedElement) {
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç
                addElement(state.selectedTool, x, y);
            } else if (clickedElement) {
                selectElement(clickedElement);
            } else {
                deselectAll();
            }
        }

        function handleCanvasMouseMove(e) {
            if (state.isConnecting && state.connectionStart) {
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX - rect.left + canvasContainer.scrollLeft) / state.zoom;
                const y = (e.clientY - rect.top + canvasContainer.scrollTop) / state.zoom;
                
                updateConnectionPreview(x, y);
            }
        }

        function handleContextMenu(e) {
            e.preventDefault();
            
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left + canvasContainer.scrollLeft) / state.zoom;
            const y = (e.clientY - rect.top + canvasContainer.scrollTop) / state.zoom;
            
            const clickedElement = getElementAtPosition(x, y);
            
            if (clickedElement) {
                selectElement(clickedElement);
                showContextMenu(e.clientX, e.clientY);
            }
        }

        function handleKeyDown(e) {
            if (e.key === 'Delete' || e.key === 'Backspace') {
                if (state.selectedElement && document.activeElement.tagName !== 'INPUT' && 
                    document.activeElement.tagName !== 'TEXTAREA') {
                    deleteSelected();
                }
            } else if (e.key === 'Escape') {
                state.isConnecting = false;
                state.connectionStart = null;
                state.selectedTool = null;
                document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById('connection-preview').style.display = 'none';
                canvasArea.classList.remove('connecting-mode');
                updateCanvasInfo('–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —Ö–æ–ª—Å—Ç');
                closeModal();
            }
        }

        // ==================== –†–ê–ë–û–¢–ê –° –≠–õ–ï–ú–ï–ù–¢–ê–ú–ò ====================
        function addElement(type, x, y) {
            const config = elementConfig[type];
            const element = {
                id: state.nextId++,
                type: type,
                x: x - config.width / 2,
                y: y - config.height / 2,
                width: config.width,
                height: config.height,
                text: config.defaultText,
                yesLabel: type === 'question' ? '–î–∞' : null,
                noLabel: type === 'question' ? '–ù–µ—Ç' : null
            };

            state.elements.push(element);
            renderElement(element);
            updateStatus();
            
            // –í—ã–±–∏—Ä–∞–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
            selectElement(element);
        }

        function renderElement(element) {
            const config = elementConfig[element.type];
            const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            group.setAttribute('class', 'drakon-element');
            group.setAttribute('data-id', element.id);
            group.setAttribute('transform', `translate(${element.x}, ${element.y})`);

            // –°–æ–∑–¥–∞—ë–º —Ñ–æ—Ä–º—É —ç–ª–µ–º–µ–Ω—Ç–∞
            const shape = createShape(element.type, element.width, element.height, config);
            shape.setAttribute('class', 'element-shape');
            group.appendChild(shape);

            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
            const text = createTextElement(element.text, element.width, element.height, config.textColor);
            group.appendChild(text);

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            group.addEventListener('mousedown', (e) => handleElementMouseDown(e, element));
            group.addEventListener('dblclick', () => openEditModal(element));

            elementsLayer.appendChild(group);
        }

        function createShape(type, width, height, config) {
            let shape;
            const fill = config.gradient;
            const stroke = config.stroke || 'none';
            const strokeWidth = stroke !== 'none' ? 2 : 0;

            switch (config.shape) {
                case 'rounded-rect':
                    shape = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    shape.setAttribute('width', width);
                    shape.setAttribute('height', height);
                    shape.setAttribute('rx', height / 2);
                    shape.setAttribute('ry', height / 2);
                    break;

                case 'rect':
                    shape = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    shape.setAttribute('width', width);
                    shape.setAttribute('height', height);
                    shape.setAttribute('rx', 4);
                    break;

                case 'diamond':
                    shape = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
                    const hw = width / 2;
                    const hh = height / 2;
                    shape.setAttribute('points', `${hw},0 ${width},${hh} ${hw},${height} 0,${hh}`);
                    break;

                case 'parallelogram-right':
                    shape = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
                    const skew = 15;
                    shape.setAttribute('points', `${skew},0 ${width},0 ${width-skew},${height} 0,${height}`);
                    break;

                case 'parallelogram-left':
                    shape = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
                    const sk = 15;
                    shape.setAttribute('points', `0,0 ${width-sk},0 ${width},${height} ${sk},${height}`);
                    break;

                case 'insert-rect':
                    shape = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                    const mainRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    mainRect.setAttribute('width', width);
                    mainRect.setAttribute('height', height);
                    mainRect.setAttribute('rx', 4);
                    mainRect.setAttribute('fill', fill);
                    shape.appendChild(mainRect);
                    
                    // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏ –ø–æ –±–æ–∫–∞–º
                    const leftLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    leftLine.setAttribute('x1', 10);
                    leftLine.setAttribute('y1', 5);
                    leftLine.setAttribute('x2', 10);
                    leftLine.setAttribute('y2', height - 5);
                    leftLine.setAttribute('stroke', 'white');
                    leftLine.setAttribute('stroke-width', 2);
                    shape.appendChild(leftLine);
                    
                    const rightLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    rightLine.setAttribute('x1', width - 10);
                    rightLine.setAttribute('y1', 5);
                    rightLine.setAttribute('x2', width - 10);
                    rightLine.setAttribute('y2', height - 5);
                    rightLine.setAttribute('stroke', 'white');
                    rightLine.setAttribute('stroke-width', 2);
                    shape.appendChild(rightLine);
                    return shape;

                case 'comment':
                    shape = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                    const commentRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    commentRect.setAttribute('width', width);
                    commentRect.setAttribute('height', height);
                    commentRect.setAttribute('rx', 4);
                    commentRect.setAttribute('fill', fill);
                    commentRect.setAttribute('stroke', stroke);
                    commentRect.setAttribute('stroke-width', strokeWidth);
                    shape.appendChild(commentRect);
                    
                    const bracketLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    bracketLine.setAttribute('x1', 0);
                    bracketLine.setAttribute('y1', 10);
                    bracketLine.setAttribute('x2', 0);
                    bracketLine.setAttribute('y2', height - 10);
                    bracketLine.setAttribute('stroke', '#2c3e50');
                    bracketLine.setAttribute('stroke-width', 3);
                    shape.appendChild(bracketLine);
                    return shape;

                default:
                    shape = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    shape.setAttribute('width', width);
                    shape.setAttribute('height', height);
            }

            shape.setAttribute('fill', fill);
            if (stroke !== 'none') {
                shape.setAttribute('stroke', stroke);
                shape.setAttribute('stroke-width', strokeWidth);
            }

            return shape;
        }

        function createTextElement(text, width, height, color) {
            const textEl = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            textEl.setAttribute('x', width / 2);
            textEl.setAttribute('y', height / 2);
            textEl.setAttribute('text-anchor', 'middle');
            textEl.setAttribute('dominant-baseline', 'middle');
            textEl.setAttribute('fill', color);
            textEl.setAttribute('class', 'element-text');
            
            // –†–∞–∑–±–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ —Å—Ç—Ä–æ–∫–∏
            const lines = text.split('\n');
            const lineHeight = 16;
            const startY = height / 2 - ((lines.length - 1) * lineHeight) / 2;
            
            lines.forEach((line, i) => {
                const tspan = document.createElementNS('http://www.w3.org/2000/svg', 'tspan');
                tspan.setAttribute('x', width / 2);
                tspan.setAttribute('dy', i === 0 ? 0 : lineHeight);
                tspan.textContent = line;
                textEl.appendChild(tspan);
            });
            
            // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –ø–æ–∑–∏—Ü–∏—é –¥–ª—è –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
            if (lines.length > 1) {
                textEl.setAttribute('y', startY);
            }
            
            return textEl;
        }

        function updateElement(element) {
            const group = document.querySelector(`g[data-id="${element.id}"]`);
            if (group) {
                group.remove();
                renderElement(element);
                if (state.selectedElement && state.selectedElement.id === element.id) {
                    const newGroup = document.querySelector(`g[data-id="${element.id}"]`);
                    newGroup.classList.add('selected');
                }
            }
        }

        function getElementAtPosition(x, y) {
            for (let i = state.elements.length - 1; i >= 0; i--) {
                const el = state.elements[i];
                if (x >= el.x && x <= el.x + el.width &&
                    y >= el.y && y <= el.y + el.height) {
                    return el;
                }
            }
            return null;
        }

        function selectElement(element) {
            deselectAll();
            state.selectedElement = element;
            const group = document.querySelector(`g[data-id="${element.id}"]`);
            if (group) {
                group.classList.add('selected');
            }
            updateCanvasInfo(`–í—ã–±—Ä–∞–Ω: ${elementConfig[element.type].defaultText} (ID: ${element.id})`);
        }

        function deselectAll() {
            state.selectedElement = null;
            document.querySelectorAll('.drakon-element.selected').forEach(el => {
                el.classList.remove('selected');
            });
        }

        // ==================== –ü–ï–†–ï–¢–ê–°–ö–ò–í–ê–ù–ò–ï ====================
        function handleElementMouseDown(e, element) {
            if (state.isConnecting) return;
            
            e.stopPropagation();
            state.isDragging = true;
            state.selectedElement = element;
            
            const rect = canvas.getBoundingClientRect();
            state.dragOffset = {
                x: (e.clientX - rect.left + canvasContainer.scrollLeft) / state.zoom - element.x,
                y: (e.clientY - rect.top + canvasContainer.scrollTop) / state.zoom - element.y
            };

            selectElement(element);

            const handleMouseMove = (e) => {
                if (!state.isDragging) return;
                
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX - rect.left + canvasContainer.scrollLeft) / state.zoom - state.dragOffset.x;
                const y = (e.clientY - rect.top + canvasContainer.scrollTop) / state.zoom - state.dragOffset.y;
                
                element.x = Math.max(0, x);
                element.y = Math.max(0, y);
                
                const group = document.querySelector(`g[data-id="${element.id}"]`);
                if (group) {
                    group.setAttribute('transform', `translate(${element.x}, ${element.y})`);
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤—è–∑–∏
                updateConnectionsForElement(element.id);
            };

            const handleMouseUp = () => {
                state.isDragging = false;
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
            };

            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
        }

        // ==================== –°–í–Ø–ó–ò ====================
        function handleConnectionClick(element) {
            if (!element) {
                updateCanvasInfo('–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–≤—è–∑–∏');
                return;
            }

            if (!state.connectionStart) {
                state.connectionStart = element;
                updateCanvasInfo(`–ù–∞—á–∞–ª–æ —Å–≤—è–∑–∏: ${element.text}. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–æ–Ω–µ—á–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç.`);
            } else if (state.connectionStart.id !== element.id) {
                // –°–æ–∑–¥–∞—ë–º —Å–≤—è–∑—å
                createConnection(state.connectionStart, element);
                state.connectionStart = null;
                document.getElementById('connection-preview').style.display = 'none';
                updateCanvasInfo('–°–≤—è–∑—å —Å–æ–∑–¥–∞–Ω–∞! –ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –Ω–æ–≤–æ–π —Å–≤—è–∑–∏ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ Esc.');
            }
        }

        function createConnection(from, to, label = '') {
            const connection = {
                id: state.nextId++,
                fromId: from.id,
                toId: to.id,
                label: label
            };
            
            state.connections.push(connection);
            renderConnection(connection);
            updateStatus();
        }

        function renderConnection(connection) {
            const fromEl = state.elements.find(e => e.id === connection.fromId);
            const toEl = state.elements.find(e => e.id === connection.toId);
            
            if (!fromEl || !toEl) return;

            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('class', 'connection-line');
            path.setAttribute('data-connection-id', connection.id);
            
            const d = calculateConnectionPath(fromEl, toEl);
            path.setAttribute('d', d);
            
            path.addEventListener('click', (e) => {
                e.stopPropagation();
                if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —Å–≤—è–∑—å?')) {
                    deleteConnection(connection.id);
                }
            });

            connectionsLayer.appendChild(path);

            // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫—É, –µ—Å–ª–∏ –µ—Å—Ç—å
            if (connection.label) {
                const midPoint = getPathMidpoint(fromEl, toEl);
                const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                label.setAttribute('x', midPoint.x);
                label.setAttribute('y', midPoint.y - 5);
                label.setAttribute('class', 'connection-label');
                label.setAttribute('text-anchor', 'middle');
                label.setAttribute('data-connection-id', connection.id);
                label.textContent = connection.label;
                connectionsLayer.appendChild(label);
            }
        }

        function calculateConnectionPath(from, to) {
            // –ù–∞—Ö–æ–¥–∏–º —Ü–µ–Ω—Ç—Ä—ã —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            const fromCenter = {
                x: from.x + from.width / 2,
                y: from.y + from.height / 2
            };
            const toCenter = {
                x: to.x + to.width / 2,
                y: to.y + to.height / 2
            };

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–æ—á–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            const fromPoint = getConnectionPoint(from, toCenter);
            const toPoint = getConnectionPoint(to, fromCenter);

            // –°–æ–∑–¥–∞—ë–º –ø—É—Ç—å —Å –∏–∑–≥–∏–±–æ–º
            const dx = toPoint.x - fromPoint.x;
            const dy = toPoint.y - fromPoint.y;
            
            if (Math.abs(dy) > Math.abs(dx)) {
                // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
                const midY = fromPoint.y + dy / 2;
                return `M ${fromPoint.x} ${fromPoint.y} 
                        L ${fromPoint.x} ${midY} 
                        L ${toPoint.x} ${midY} 
                        L ${toPoint.x} ${toPoint.y}`;
            } else {
                // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
                const midX = fromPoint.x + dx / 2;
                return `M ${fromPoint.x} ${fromPoint.y} 
                        L ${midX} ${fromPoint.y} 
                        L ${midX} ${toPoint.y} 
                        L ${toPoint.x} ${toPoint.y}`;
            }
        }

        function getConnectionPoint(element, targetCenter) {
            const center = {
                x: element.x + element.width / 2,
                y: element.y + element.height / 2
            };
            
            const dx = targetCenter.x - center.x;
            const dy = targetCenter.y - center.y;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–æ—Ä–æ–Ω—É –≤—ã—Ö–æ–¥–∞
            if (Math.abs(dx) > Math.abs(dy)) {
                // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                return {
                    x: dx > 0 ? element.x + element.width : element.x,
                    y: center.y
                };
            } else {
                // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                return {
                    x: center.x,
                    y: dy > 0 ? element.y + element.height : element.y
                };
            }
        }

        function getPathMidpoint(from, to) {
            return {
                x: (from.x + from.width / 2 + to.x + to.width / 2) / 2,
                y: (from.y + from.height / 2 + to.y + to.height / 2) / 2
            };
        }

        function updateConnectionPreview(x, y) {
            if (!state.connectionStart) return;
            
            const preview = document.getElementById('connection-preview');
            const from = state.connectionStart;
            const fromCenter = {
                x: from.x + from.width / 2,
                y: from.y + from.height / 2
            };
            
            preview.setAttribute('d', `M ${fromCenter.x} ${fromCenter.y} L ${x} ${y}`);
            preview.style.display = 'block';
        }

        function updateConnectionsForElement(elementId) {
            state.connections.forEach(conn => {
                if (conn.fromId === elementId || conn.toId === elementId) {
                    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –ª–∏–Ω–∏—é
                    const oldPath = document.querySelector(`path[data-connection-id="${conn.id}"]`);
                    const oldLabel = document.querySelector(`text[data-connection-id="${conn.id}"]`);
                    if (oldPath) oldPath.remove();
                    if (oldLabel) oldLabel.remove();
                    // –†–∏—Å—É–µ–º –Ω–æ–≤—É—é
                    renderConnection(conn);
                }
            });
        }

        function deleteConnection(id) {
            state.connections = state.connections.filter(c => c.id !== id);
            const path = document.querySelector(`path[data-connection-id="${id}"]`);
            const label = document.querySelector(`text[data-connection-id="${id}"]`);
            if (path) path.remove();
            if (label) label.remove();
            updateStatus();
        }

        // ==================== –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û ====================
        function openEditModal(element) {
            state.editingElement = element;
            document.getElementById('element-text').value = element.text;
            document.getElementById('modal-title').textContent = 
                `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: ${elementConfig[element.type].defaultText}`;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª—è –¥–ª—è –≤–æ–ø—Ä–æ—Å–∞
            const isQuestion = element.type === 'question';
            document.getElementById('yes-label-group').style.display = isQuestion ? 'block' : 'none';
            document.getElementById('no-label-group').style.display = isQuestion ? 'block' : 'none';
            
            if (isQuestion) {
                document.getElementById('yes-label').value = element.yesLabel || '–î–∞';
                document.getElementById('no-label').value = element.noLabel || '–ù–µ—Ç';
            }
            
            document.getElementById('modal-overlay').classList.add('active');
            document.getElementById('element-text').focus();
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.remove('active');
            state.editingElement = null;
        }

        function saveElement() {
            if (!state.editingElement) return;
            
            state.editingElement.text = document.getElementById('element-text').value || 
                                        elementConfig[state.editingElement.type].defaultText;
            
            if (state.editingElement.type === 'question') {
                state.editingElement.yesLabel = document.getElementById('yes-label').value || '–î–∞';
                state.editingElement.noLabel = document.getElementById('no-label').value || '–ù–µ—Ç';
            }
            
            updateElement(state.editingElement);
            closeModal();
        }

        // ==================== –ö–û–ù–¢–ï–ö–°–¢–ù–û–ï –ú–ï–ù–Æ ====================
        function showContextMenu(x, y) {
            const menu = document.getElementById('context-menu');
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
            menu.classList.add('active');
        }

        function editSelectedElement() {
            if (state.selectedElement) {
                openEditModal(state.selectedElement);
            }
            document.getElementById('context-menu').classList.remove('active');
        }

        function duplicateElement() {
            if (!state.selectedElement) return;
            
            const original = state.selectedElement;
            const newElement = {
                ...original,
                id: state.nextId++,
                x: original.x + 30,
                y: original.y + 30
            };
            
            state.elements.push(newElement);
            renderElement(newElement);
            selectElement(newElement);
            updateStatus();
            
            document.getElementById('context-menu').classList.remove('active');
        }

        function bringToFront() {
            if (!state.selectedElement) return;
            
            const index = state.elements.findIndex(e => e.id === state.selectedElement.id);
            if (index > -1) {
                const [element] = state.elements.splice(index, 1);
                state.elements.push(element);
                
                const group = document.querySelector(`g[data-id="${element.id}"]`);
                elementsLayer.appendChild(group);
            }
            
            document.getElementById('context-menu').classList.remove('active');
        }

        function sendToBack() {
            if (!state.selectedElement) return;
            
            const index = state.elements.findIndex(e => e.id === state.selectedElement.id);
            if (index > -1) {
                const [element] = state.elements.splice(index, 1);
                state.elements.unshift(element);
                
                const group = document.querySelector(`g[data-id="${element.id}"]`);
                elementsLayer.insertBefore(group, elementsLayer.firstChild);
            }
            
            document.getElementById('context-menu').classList.remove('active');
        }

        function deleteSelected() {
            if (!state.selectedElement) return;
            
            const id = state.selectedElement.id;
            
            // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç
            state.elements = state.elements.filter(e => e.id !== id);
            
            // –£–¥–∞–ª—è–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            const connectionsToRemove = state.connections.filter(
                c => c.fromId === id || c.toId === id
            );
            connectionsToRemove.forEach(c => {
                const path = document.querySelector(`path[data-connection-id="${c.id}"]`);
                const label = document.querySelector(`text[data-connection-id="${c.id}"]`);
                if (path) path.remove();
                if (label) label.remove();
            });
            state.connections = state.connections.filter(
                c => c.fromId !== id && c.toId !== id
            );
            
            // –£–¥–∞–ª—è–µ–º DOM-—ç–ª–µ–º–µ–Ω—Ç
            const group = document.querySelector(`g[data-id="${id}"]`);
            if (group) group.remove();
            
            state.selectedElement = null;
            updateStatus();
            
            document.getElementById('context-menu').classList.remove('active');
        }

        // ==================== –ú–ê–°–®–¢–ê–ë–ò–†–û–í–ê–ù–ò–ï ====================
        function zoomIn() {
            state.zoom = Math.min(2, state.zoom + 0.1);
            applyZoom();
        }

        function zoomOut() {
            state.zoom = Math.max(0.5, state.zoom - 0.1);
            applyZoom();
        }

        function resetZoom() {
            state.zoom = 1;
            applyZoom();
        }

        function applyZoom() {
            canvas.style.transform = `scale(${state.zoom})`;
            canvas.style.transformOrigin = '0 0';
            document.getElementById('zoom-level').textContent = Math.round(state.zoom * 100) + '%';
        }

        // ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
        function updateCanvasInfo(text) {
            document.getElementById('canvas-info').textContent = text;
        }

        function updateStatus() {
            document.getElementById('element-count').textContent = `–≠–ª–µ–º–µ–Ω—Ç–æ–≤: ${state.elements.length}`;
            document.getElementById('connection-count').textContent = `–°–≤—è–∑–µ–π: ${state.connections.length}`;
        }

        function clearCanvas() {
            if (state.elements.length === 0 && state.connections.length === 0) return;
            
            if (confirm('–û—á–∏—Å—Ç–∏—Ç—å —Ö–æ–ª—Å—Ç? –í—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.')) {
                state.elements = [];
                state.connections = [];
                state.selectedElement = null;
                elementsLayer.innerHTML = '';
                connectionsLayer.innerHTML = '';
                updateStatus();
                updateCanvasInfo('–•–æ–ª—Å—Ç –æ—á–∏—â–µ–Ω. –í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç.');
            }
        }

        function loadExample() {
            clearCanvasWithoutConfirm();
            
            // –°–æ–∑–¥–∞—ë–º –ø—Ä–∏–º–µ—Ä –∞–ª–≥–æ—Ä–∏—Ç–º–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
            const elements = [
                { type: 'start', x: 400, y: 50, text: '–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ' },
                { type: 'input', x: 400, y: 140, text: '–í—ã–±—Ä–∞—Ç—å —è–∑—ã–∫' },
                { type: 'question', x: 400, y: 240, text: '–†—É—Å—Å–∫–∏–π?' },
                { type: 'output', x: 250, y: 360, text: '–ü—Ä–∏–≤–µ—Ç!' },
                { type: 'output', x: 550, y: 360, text: 'Hello!' },
                { type: 'end', x: 400, y: 480, text: '–ö–æ–Ω–µ—Ü' }
            ];

            elements.forEach(el => {
                const config = elementConfig[el.type];
                const element = {
                    id: state.nextId++,
                    type: el.type,
                    x: el.x - config.width / 2,
                    y: el.y - config.height / 2,
                    width: config.width,
                    height: config.height,
                    text: el.text,
                    yesLabel: el.type === 'question' ? '–î–∞' : null,
                    noLabel: el.type === 'question' ? '–ù–µ—Ç' : null
                };
                state.elements.push(element);
                renderElement(element);
            });

            // –°–æ–∑–¥–∞—ë–º —Å–≤—è–∑–∏
            const connections = [
                { from: 0, to: 1 },
                { from: 1, to: 2 },
                { from: 2, to: 3, label: '–î–∞' },
                { from: 2, to: 4, label: '–ù–µ—Ç' },
                { from: 3, to: 5 },
                { from: 4, to: 5 }
            ];

            connections.forEach(conn => {
                const fromEl = state.elements[conn.from];
                const toEl = state.elements[conn.to];
                createConnection(fromEl, toEl, conn.label || '');
            });

            updateStatus();
            updateCanvasInfo('–ó–∞–≥—Ä—É–∂–µ–Ω –ø—Ä–∏–º–µ—Ä –∞–ª–≥–æ—Ä–∏—Ç–º–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è');
        }

        function clearCanvasWithoutConfirm() {
            state.elements = [];
            state.connections = [];
            state.selectedElement = null;
            state.nextId = 1;
            elementsLayer.innerHTML = '';
            connectionsLayer.innerHTML = '';
        }

        // ==================== –≠–ö–°–ü–û–†–¢ ====================
        function exportSVG() {
            const svgClone = canvas.cloneNode(true);
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –≤ SVG
            const style = document.createElementNS('http://www.w3.org/2000/svg', 'style');
            style.textContent = `
                .element-text { font-family: 'Segoe UI', sans-serif; font-size: 13px; }
                .connection-line { stroke: #2c3e50; stroke-width: 2; fill: none; }
                .connection-label { font-size: 11px; fill: #2c3e50; font-weight: 600; }
            `;
            svgClone.insertBefore(style, svgClone.firstChild);
            
            // –í—ã—á–∏—Å–ª—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã
            const bounds = calculateBounds();
            svgClone.setAttribute('viewBox', `${bounds.minX - 20} ${bounds.minY - 20} ${bounds.width + 40} ${bounds.height + 40}`);
            svgClone.setAttribute('width', bounds.width + 40);
            svgClone.setAttribute('height', bounds.height + 40);
            
            const svgData = new XMLSerializer().serializeToString(svgClone);
            const blob = new Blob([svgData], { type: 'image/svg+xml' });
            downloadFile(blob, 'drakon-diagram.svg');
        }

        function exportPNG() {
            const bounds = calculateBounds();
            const canvas2d = document.createElement('canvas');
            const scale = 2; // –î–ª—è –ª—É—á—à–µ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞
            canvas2d.width = (bounds.width + 40) * scale;
            canvas2d.height = (bounds.height + 40) * scale;
            
            const ctx = canvas2d.getContext('2d');
            ctx.scale(scale, scale);
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, bounds.width + 40, bounds.height + 40);
            
            const svgClone = canvas.cloneNode(true);
            svgClone.setAttribute('viewBox', `${bounds.minX - 20} ${bounds.minY - 20} ${bounds.width + 40} ${bounds.height + 40}`);
            
            const svgData = new XMLSerializer().serializeToString(svgClone);
            const img = new Image();
            
            img.onload = function() {
                ctx.drawImage(img, 0, 0);
                canvas2d.toBlob(function(blob) {
                    downloadFile(blob, 'drakon-diagram.png');
                });
            };
            
            img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));
        }

        function calculateBounds() {
            if (state.elements.length === 0) {
                return { minX: 0, minY: 0, width: 400, height: 300 };
            }
            
            let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
            
            state.elements.forEach(el => {
                minX = Math.min(minX, el.x);
                minY = Math.min(minY, el.y);
                maxX = Math.max(maxX, el.x + el.width);
                maxY = Math.max(maxY, el.y + el.height);
            });
            
            return {
                minX,
                minY,
                width: maxX - minX,
                height: maxY - minY
            };
        }

        function downloadFile(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showHelp() {
            alert(`–î–†–ê–ö–û–ù-—Ä–µ–¥–∞–∫—Ç–æ—Ä ‚Äî –°–ø—Ä–∞–≤–∫–∞

–î–†–ê–ö–û–ù (–î—Ä—É–∂–µ–ª—é–±–Ω—ã–π –†—É—Å—Å–∫–∏–π –ê–ª–≥–æ—Ä–∏—Ç–º–∏—á–µ—Å–∫–∏–π —è–∑—ã–∫, –ö–æ—Ç–æ—Ä—ã–π –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ù–∞–≥–ª—è–¥–Ω–æ—Å—Ç—å) ‚Äî –≤–∏–∑—É–∞–ª—å–Ω—ã–π —è–∑—ã–∫ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤.

–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:
‚Ä¢ –ß—Ç–µ–Ω–∏–µ —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑ ‚Äî –∫–∞–∫ –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç
‚Ä¢ ¬´–ß–µ–º –ø—Ä–∞–≤–µ–µ ‚Äî —Ç–µ–º —Ö—É–∂–µ¬ª ‚Äî –∏—Å–∫–ª—é—á–µ–Ω–∏—è —Å–ø—Ä–∞–≤–∞
‚Ä¢ –û–¥–∏–Ω –≤—Ö–æ–¥, –æ–¥–∏–Ω –≤—ã—Ö–æ–¥ ‚Äî –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –±–ª–æ–∫–∞

–°–≤—è–∑—å —Å –ª–∏–Ω–≥–≤–∏—Å—Ç–∏–∫–æ–π:
‚Ä¢ –ê–ª–≥–æ—Ä–∏—Ç–º = —Ç–µ–∫—Å—Ç —Å —á—ë—Ç–∫–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
‚Ä¢ –ë–ª–æ–∫–∏ = –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è-–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
‚Ä¢ –í–æ–ø—Ä–æ—Å—ã = —Ç–æ—á–∫–∏ –≤—ã–±–æ—Ä–∞ –≤ –¥–∏–∞–ª–æ–≥–µ
‚Ä¢ –°–≤—è–∑–∏ = –ª–æ–≥–∏—á–µ—Å–∫–∞—è –∫–æ–≥–µ–∑–∏—è

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä –¥–ª—è –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏—è:
‚Ä¢ –ê–ª–≥–æ—Ä–∏—Ç–º–æ–≤ –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–∫—Å—Ç–∞
‚Ä¢ –°—Ü–µ–Ω–∞—Ä–∏–µ–≤ –¥–∏–∞–ª–æ–≥–∞
‚Ä¢ –ü—Ä–∞–≤–∏–ª –≥—Ä–∞–º–º–∞—Ç–∏–∫–∏
‚Ä¢ –ú–µ—Ç–æ–¥–∏–∫ –æ–±—É—á–µ–Ω–∏—è`);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        updateStatus();
    </script>
</body>
</html>