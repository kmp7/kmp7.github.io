<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>kmp+</title>
    <style>
        :root {
            --primary: #4a6fa5;
            --secondary: #6b8cae;
            --accent: #e07a5f;
            --success: #81b29a;
            --warning: #f2cc8f;
            --bg: #f8f9fa;
            --card-bg: #ffffff;
            --text: #2d3748;
            --text-light: #718096;
            --shadow: 0 4px 20px rgba(0,0,0,0.1);
            --radius: 12px;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            padding: 20px;
        }

        .header {
            text-align: center;
            padding: 30px 20px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: var(--radius);
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            max-width: 700px;
            margin: 0 auto;
        }

        .levels-hint {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .level-badge {
            background: rgba(255,255,255,0.2);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            backdrop-filter: blur(5px);
        }

        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 25px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .card-subtitle {
            font-size: 0.8rem;
            opacity: 0.85;
            font-style: italic;
        }

        .example-toggle {
            display: flex;
            gap: 5px;
        }

        .toggle-btn {
            padding: 5px 12px;
            border: none;
            border-radius: 15px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: var(--transition);
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .toggle-btn.active {
            background: white;
            color: var(--primary);
        }

        .toggle-btn:hover:not(.active) {
            background: rgba(255,255,255,0.35);
        }

        .svg-container {
            padding: 20px;
            background: #fafbfc;
            min-height: 280px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .diagram-svg {
            max-width: 100%;
            height: auto;
        }

        /* SVG Element Styles */
        .svg-element {
            transition: var(--transition);
            cursor: pointer;
        }

        .svg-element:hover,
        .svg-element.highlighted {
            filter: drop-shadow(0 0 8px var(--accent));
        }

        .svg-element.highlighted rect,
        .svg-element.highlighted ellipse,
        .svg-element.highlighted polygon,
        .svg-element.highlighted path {
            stroke: var(--accent);
            stroke-width: 3;
        }

        .svg-class-box rect {
            fill: #e8f4f8;
            stroke: var(--primary);
            stroke-width: 2;
        }

        .svg-actor ellipse {
            fill: #fff3e0;
            stroke: var(--accent);
            stroke-width: 2;
        }

        .svg-usecase ellipse {
            fill: #e8f5e9;
            stroke: var(--success);
            stroke-width: 2;
        }

        .svg-lifeline rect {
            fill: #fff8e1;
            stroke: var(--warning);
            stroke-width: 2;
        }

        .svg-state rect,
        .svg-state ellipse {
            fill: #f3e5f5;
            stroke: #9c27b0;
            stroke-width: 2;
            rx: 10;
        }

        .svg-activity rect {
            fill: #e1f5fe;
            stroke: #03a9f4;
            stroke-width: 2;
            rx: 8;
        }

        .svg-decision polygon {
            fill: #fff9c4;
            stroke: #ffc107;
            stroke-width: 2;
        }

        .svg-arrow {
            stroke: #666;
            stroke-width: 2;
            fill: none;
        }

        .svg-arrow-head {
            fill: #666;
        }

        .svg-text {
            font-family: 'Segoe UI', sans-serif;
            font-size: 11px;
            fill: var(--text);
            pointer-events: none;
        }

        .svg-text-small {
            font-size: 9px;
            fill: var(--text-light);
        }

        /* Tooltip */
        .tooltip {
            position: absolute;
            background: rgba(45, 55, 72, 0.95);
            color: white;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 0.85rem;
            max-width: 250px;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            pointer-events: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .tooltip.visible {
            opacity: 1;
            visibility: visible;
        }

        .tooltip::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid rgba(45, 55, 72, 0.95);
        }

        .info-panel {
            padding: 20px;
            border-top: 1px solid #eee;
        }

        .analogy-box {
            background: linear-gradient(135deg, #f0f7ff, #e8f4f8);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary);
        }

        .analogy-box h4 {
            color: var(--primary);
            font-size: 0.9rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .analogy-box p {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .example-box {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            font-size: 0.85rem;
        }

        .example-box .label {
            font-weight: 600;
            color: var(--accent);
            display: block;
            margin-bottom: 5px;
        }

        /* Step controls */
        .step-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .step-btn {
            padding: 8px 20px;
            border: 2px solid var(--primary);
            background: white;
            color: var(--primary);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: var(--transition);
        }

        .step-btn:hover {
            background: var(--primary);
            color: white;
        }

        .step-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .step-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .step-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ddd;
            transition: var(--transition);
        }

        .step-dot.active {
            background: var(--accent);
            transform: scale(1.3);
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 30px;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            border: 2px solid;
        }

        @media (max-width: 480px) {
            .cards-container {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .card-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>Диаграммы UML</h1>
        <p>Изучаем моделирование через призму языка</p>
        <div class="levels-hint">
            <span class="level-badge">Лексический уровень</span>
            <span class="level-badge">Синтаксический уровень</span>
            <span class="level-badge">Дискурсивный уровень</span>
            <span class="level-badge">Прагматический уровень</span>
        </div>
    </header>

    <main class="cards-container" id="cardsContainer">
        <!-- Cards will be generated by JavaScript -->
    </main>

    <div class="legend">
        <div class="legend-item">
            <div class="legend-color" style="background:#e8f4f8;border-color:#4a6fa5;"></div>
            <span>Класс/Сущность</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background:#fff3e0;border-color:#e07a5f;"></div>
            <span>Актор/Участник</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background:#e8f5e9;border-color:#81b29a;"></div>
            <span>Вариант использования</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background:#f3e5f5;border-color:#9c27b0;"></div>
            <span>Состояние</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background:#e1f5fe;border-color:#03a9f4;"></div>
            <span>Действие/Активность</span>
        </div>
    </div>

    <footer class="footer">
<div class="container">
<p>© 2026 | kmp | CC BY-NC-SA 4.0<br>
для всех</p>
</div>
</footer>
<div style="position: fixed; bottom: 10px; color: #777777; right: 30px; opacity: 0.3; font-size: 14px;">kmp+</div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        // ============ DATA ============
        const diagramsData = {
            class: {
                title: "Диаграмма классов",
                subtitle: "Class Diagram",
                level: "Лексический уровень",
                analogy: {
                    title: "Лексическая сеть / Словарь",
                    text: "Подобно тому, как в лингвистике мы описываем отношения между словами (гипероним-гипоним, часть-целое), диаграмма классов моделирует структуру понятий и их связи."
                },
                examples: {
                    linguistic: {
                        label: "Морфологическая иерархия",
                        text: "Noun (Существительное) ← ProperNoun (Имя собственное). Атрибуты: gender, number, case. Связь: Subject—Verb—Object"
                    },
                    generic: {
                        label: "Система заказов",
                        text: "Order содержит OrderItems. Customer связан с Order. Product имеет атрибуты: name, price, quantity."
                    }
                },
                elements: [
                    { id: "class1", tooltip: "Класс 'Noun' — базовая часть речи (гипероним)", step: 1 },
                    { id: "class2", tooltip: "Класс 'ProperNoun' — наследует от Noun", step: 2 },
                    { id: "class3", tooltip: "Класс 'Verb' — связан через ассоциацию", step: 3 },
                    { id: "relation1", tooltip: "Наследование: 'is-a' (ProperNoun является Noun)", step: 2 },
                    { id: "relation2", tooltip: "Ассоциация: субъект управляет глаголом", step: 4 }
                ],
                svgLinguistic: `
                    <svg viewBox="0 0 360 220" class="diagram-svg">
                        <!-- Noun class -->
                        <g class="svg-element svg-class-box" data-id="class1">
                            <rect x="120" y="10" width="120" height="70" rx="3"/>
                            <line x1="120" y1="35" x2="240" y2="35" stroke="#4a6fa5" stroke-width="1"/>
                            <line x1="120" y1="55" x2="240" y2="55" stroke="#4a6fa5" stroke-width="1"/>
                            <text x="180" y="27" class="svg-text" text-anchor="middle" font-weight="bold">Noun</text>
                            <text x="130" y="48" class="svg-text-small">+ gender: String</text>
                            <text x="130" y="68" class="svg-text-small">+ getPlural()</text>
                        </g>
                        
                        <!-- Inheritance arrow -->
                        <g class="svg-element" data-id="relation1">
                            <line x1="180" y1="80" x2="180" y2="110" class="svg-arrow"/>
                            <polygon points="175,110 180,120 185,110" class="svg-arrow-head" fill="none" stroke="#666" stroke-width="2"/>
                        </g>
                        
                        <!-- ProperNoun class -->
                        <g class="svg-element svg-class-box" data-id="class2">
                            <rect x="120" y="120" width="120" height="55" rx="3"/>
                            <line x1="120" y1="145" x2="240" y2="145" stroke="#4a6fa5" stroke-width="1"/>
                            <text x="180" y="137" class="svg-text" text-anchor="middle" font-weight="bold">ProperNoun</text>
                            <text x="130" y="163" class="svg-text-small">+ capitalize()</text>
                        </g>
                        
                        <!-- Verb class -->
                        <g class="svg-element svg-class-box" data-id="class3">
                            <rect x="260" y="30" width="90" height="55" rx="3"/>
                            <line x1="260" y1="55" x2="350" y2="55" stroke="#4a6fa5" stroke-width="1"/>
                            <text x="305" y="47" class="svg-text" text-anchor="middle" font-weight="bold">Verb</text>
                            <text x="268" y="73" class="svg-text-small">+ tense</text>
                        </g>
                        
                        <!-- Association -->
                        <g class="svg-element" data-id="relation2">
                            <line x1="240" y1="45" x2="260" y2="50" class="svg-arrow"/>
                            <text x="245" y="38" class="svg-text-small">governs</text>
                        </g>
                        
                        <!-- Adjective -->
                        <g class="svg-element svg-class-box" data-id="class4">
                            <rect x="10" y="30" width="90" height="55" rx="3"/>
                            <line x1="10" y1="55" x2="100" y2="55" stroke="#4a6fa5" stroke-width="1"/>
                            <text x="55" y="47" class="svg-text" text-anchor="middle" font-weight="bold">Adjective</text>
                            <text x="18" y="73" class="svg-text-small">+ degree</text>
                        </g>
                        
                        <g class="svg-element" data-id="relation3">
                            <line x1="100" y1="50" x2="120" y2="45" class="svg-arrow" stroke-dasharray="5,3"/>
                            <text x="102" y="38" class="svg-text-small">modifies</text>
                        </g>
                    </svg>
                `,
                svgGeneric: `
                    <svg viewBox="0 0 360 220" class="diagram-svg">
                        <g class="svg-element svg-class-box" data-id="class1">
                            <rect x="120" y="10" width="120" height="70" rx="3"/>
                            <line x1="120" y1="35" x2="240" y2="35" stroke="#4a6fa5"/>
                            <line x1="120" y1="55" x2="240" y2="55" stroke="#4a6fa5"/>
                            <text x="180" y="27" class="svg-text" text-anchor="middle" font-weight="bold">Order</text>
                            <text x="130" y="48" class="svg-text-small">+ orderDate</text>
                            <text x="130" y="68" class="svg-text-small">+ getTotal()</text>
                        </g>
                        
                        <g class="svg-element svg-class-box" data-id="class2">
                            <rect x="10" y="30" width="90" height="55" rx="3"/>
                            <line x1="10" y1="55" x2="100" y2="55" stroke="#4a6fa5"/>
                            <text x="55" y="47" class="svg-text" text-anchor="middle" font-weight="bold">Customer</text>
                            <text x="18" y="73" class="svg-text-small">+ name</text>
                        </g>
                        
                        <g class="svg-element svg-class-box" data-id="class3">
                            <rect x="260" y="30" width="90" height="55" rx="3"/>
                            <line x1="260" y1="55" x2="350" y2="55" stroke="#4a6fa5"/>
                            <text x="305" y="47" class="svg-text" text-anchor="middle" font-weight="bold">Product</text>
                            <text x="268" y="73" class="svg-text-small">+ price</text>
                        </g>
                        
                        <g class="svg-element svg-class-box" data-id="class4">
                            <rect x="120" y="130" width="120" height="55" rx="3"/>
                            <line x1="120" y1="155" x2="240" y2="155" stroke="#4a6fa5"/>
                            <text x="180" y="147" class="svg-text" text-anchor="middle" font-weight="bold">OrderItem</text>
                            <text x="130" y="173" class="svg-text-small">+ quantity</text>
                        </g>
                        
                        <g class="svg-element" data-id="relation1">
                            <line x1="100" y1="57" x2="120" y2="45" class="svg-arrow"/>
                            <text x="105" y="40" class="svg-text-small">1..*</text>
                        </g>
                        
                        <g class="svg-element" data-id="relation2">
                            <line x1="180" y1="80" x2="180" y2="130" class="svg-arrow"/>
                            <polygon points="170,120 180,130 190,120" fill="white" stroke="#666"/>
                        </g>
                    </svg>
                `
            },
            usecase: {
                title: "Диаграмма вариантов использования",
                subtitle: "Use Case Diagram",
                level: "Прагматический уровень",
                analogy: {
                    title: "Коммуникативные цели и роли",
                    text: "Как в теории речевых актов мы выделяем говорящего, слушающего и иллокутивную цель, так Use Case показывает акторов и их цели взаимодействия с системой."
                },
                examples: {
                    linguistic: {
                        label: "Учебная коммуникация",
                        text: "Student (ученик) → 'Выполнить упражнение', 'Получить обратную связь'. Teacher → 'Создать задание', 'Оценить работу'."
                    },
                    generic: {
                        label: "Интернет-магазин",
                        text: "Customer → 'Просмотреть каталог', 'Оформить заказ'. Admin → 'Управлять товарами'."
                    }
                },
                elements: [
                    { id: "actor1", tooltip: "Актор 'Student' — инициатор действия (говорящий)", step: 1 },
                    { id: "actor2", tooltip: "Актор 'Teacher' — другой участник коммуникации", step: 2 },
                    { id: "uc1", tooltip: "Use Case — коммуникативная цель ученика", step: 3 },
                    { id: "uc2", tooltip: "Use Case — получение feedback", step: 4 },
                    { id: "uc3", tooltip: "Действие преподавателя", step: 5 }
                ],
                svgLinguistic: `
                    <svg viewBox="0 0 380 240" class="diagram-svg">
                        <!-- System boundary -->
                        <rect x="100" y="10" width="200" height="220" fill="none" stroke="#999" stroke-dasharray="5,5" rx="10"/>
                        <text x="200" y="30" class="svg-text" text-anchor="middle" font-style="italic">Learning System</text>
                        
                        <!-- Student actor -->
                        <g class="svg-element svg-actor" data-id="actor1">
                            <ellipse cx="40" cy="60" rx="20" ry="20"/>
                            <line x1="40" y1="80" x2="40" y2="120" stroke="#e07a5f" stroke-width="2"/>
                            <line x1="20" y1="95" x2="60" y2="95" stroke="#e07a5f" stroke-width="2"/>
                            <line x1="40" y1="120" x2="25" y2="150" stroke="#e07a5f" stroke-width="2"/>
                            <line x1="40" y1="120" x2="55" y2="150" stroke="#e07a5f" stroke-width="2"/>
                            <text x="40" y="170" class="svg-text" text-anchor="middle">Student</text>
                        </g>
                        
                        <!-- Teacher actor -->
                        <g class="svg-element svg-actor" data-id="actor2">
                            <ellipse cx="340" cy="100" rx="20" ry="20"/>
                            <line x1="340" y1="120" x2="340" y2="160" stroke="#e07a5f" stroke-width="2"/>
                            <line x1="320" y1="135" x2="360" y2="135" stroke="#e07a5f" stroke-width="2"/>
                            <line x1="340" y1="160" x2="325" y2="190" stroke="#e07a5f" stroke-width="2"/>
                            <line x1="340" y1="160" x2="355" y2="190" stroke="#e07a5f" stroke-width="2"/>
                            <text x="340" y="210" class="svg-text" text-anchor="middle">Teacher</text>
                        </g>
                        
                        <!-- Use cases -->
                        <g class="svg-element svg-usecase" data-id="uc1">
                            <ellipse cx="200" cy="70" rx="70" ry="25"/>
                            <text x="200" y="65" class="svg-text" text-anchor="middle">Complete</text>
                            <text x="200" y="78" class="svg-text" text-anchor="middle">Exercise</text>
                        </g>
                        
                        <g class="svg-element svg-usecase" data-id="uc2">
                            <ellipse cx="200" cy="140" rx="70" ry="25"/>
                            <text x="200" y="135" class="svg-text" text-anchor="middle">Get</text>
                            <text x="200" y="148" class="svg-text" text-anchor="middle">Feedback</text>
                        </g>
                        
                        <g class="svg-element svg-usecase" data-id="uc3">
                            <ellipse cx="200" cy="200" rx="70" ry="25"/>
                            <text x="200" y="195" class="svg-text" text-anchor="middle">Grade</text>
                            <text x="200" y="208" class="svg-text" text-anchor="middle">Work</text>
                        </g>
                        
                        <!-- Connections -->
                        <line x1="60" y1="70" x2="130" y2="70" class="svg-arrow"/>
                        <line x1="60" y1="100" x2="130" y2="130" class="svg-arrow"/>
                        <line x1="270" y1="140" x2="320" y2="120" class="svg-arrow"/>
                        <line x1="270" y1="195" x2="320" y2="150" class="svg-arrow"/>
                    </svg>
                `,
                svgGeneric: `
                    <svg viewBox="0 0 380 240" class="diagram-svg">
                        <rect x="100" y="10" width="200" height="220" fill="none" stroke="#999" stroke-dasharray="5,5" rx="10"/>
                        <text x="200" y="30" class="svg-text" text-anchor="middle" font-style="italic">E-Commerce</text>
                        
                        <g class="svg-element svg-actor" data-id="actor1">
                            <ellipse cx="40" cy="80" rx="20" ry="20"/>
                            <line x1="40" y1="100" x2="40" y2="140" stroke="#e07a5f" stroke-width="2"/>
                            <line x1="20" y1="115" x2="60" y2="115" stroke="#e07a5f" stroke-width="2"/>
                            <line x1="40" y1="140" x2="25" y2="170" stroke="#e07a5f" stroke-width="2"/>
                            <line x1="40" y1="140" x2="55" y2="170" stroke="#e07a5f" stroke-width="2"/>
                            <text x="40" y="190" class="svg-text" text-anchor="middle">Customer</text>
                        </g>
                        
                        <g class="svg-element svg-actor" data-id="actor2">
                            <ellipse cx="340" cy="120" rx="20" ry="20"/>
                            <line x1="340" y1="140" x2="340" y2="180" stroke="#e07a5f" stroke-width="2"/>
                            <line x1="320" y1="155" x2="360" y2="155" stroke="#e07a5f" stroke-width="2"/>
                            <line x1="340" y1="180" x2="325" y2="210" stroke="#e07a5f" stroke-width="2"/>
                            <line x1="340" y1="180" x2="355" y2="210" stroke="#e07a5f" stroke-width="2"/>
                            <text x="340" y="230" class="svg-text" text-anchor="middle">Admin</text>
                        </g>
                        
                        <g class="svg-element svg-usecase" data-id="uc1">
                            <ellipse cx="200" cy="70" rx="65" ry="22"/>
                            <text x="200" y="74" class="svg-text" text-anchor="middle">Browse Catalog</text>
                        </g>
                        
                        <g class="svg-element svg-usecase" data-id="uc2">
                            <ellipse cx="200" cy="130" rx="65" ry="22"/>
                            <text x="200" y="134" class="svg-text" text-anchor="middle">Place Order</text>
                        </g>
                        
                        <g class="svg-element svg-usecase" data-id="uc3">
                            <ellipse cx="200" cy="190" rx="65" ry="22"/>
                            <text x="200" y="194" class="svg-text" text-anchor="middle">Manage Products</text>
                        </g>
                        
                        <line x1="60" y1="90" x2="135" y2="75" class="svg-arrow"/>
                        <line x1="60" y1="110" x2="135" y2="125" class="svg-arrow"/>
                        <line x1="265" y1="185" x2="320" y2="150" class="svg-arrow"/>
                    </svg>
                `
            },
            sequence: {
                title: "Диаграмма последовательности",
                subtitle: "Sequence Diagram",
                level: "Дискурсивный уровень",
                analogy: {
                    title: "Диалог / Обмен репликами",
                    text: "Как в анализе дискурса мы изучаем очерёдность реплик (turn-taking), инициативу и реакцию, так диаграмма последовательности показывает обмен сообщениями во времени."
                },
                examples: {
                    linguistic: {
                        label: "Учебный диалог",
                        text: "Teacher → Student: 'Вопрос' → Student думает → Student → Teacher: 'Ответ' → Teacher: 'Оценка/Коррекция'"
                    },
                    generic: {
                        label: "Авторизация",
                        text: "User → System: login() → System → DB: validate() → DB → System: result → System → User: token"
                    }
                },
                elements: [
                    { id: "lifeline1", tooltip: "Линия жизни Teacher — инициатор диалога", step: 1 },
                    { id: "lifeline2", tooltip: "Линия жизни Student — реагирующий участник", step: 2 },
                    { id: "msg1", tooltip: "Реплика-инициатива: постановка вопроса", step: 3 },
                    { id: "msg2", tooltip: "Реплика-реакция: ответ ученика", step: 4 },
                    { id: "msg3", tooltip: "Обратная связь: оценка/коррекция", step: 5 }
                ],
                svgLinguistic: `
                    <svg viewBox="0 0 360 260" class="diagram-svg">
                        <!-- Teacher lifeline -->
                        <g class="svg-element svg-lifeline" data-id="lifeline1">
                            <rect x="40" y="20" width="80" height="35" rx="3"/>
                            <text x="80" y="43" class="svg-text" text-anchor="middle" font-weight="bold">Teacher</text>
                            <line x1="80" y1="55" x2="80" y2="240" stroke="#999" stroke-dasharray="5,3"/>
                            <rect x="75" y="70" width="10" height="50" fill="#f2cc8f" stroke="#d4a574"/>
                        </g>
                        
                        <!-- Student lifeline -->
                        <g class="svg-element svg-lifeline" data-id="lifeline2">
                            <rect x="230" y="20" width="80" height="35" rx="3"/>
                            <text x="270" y="43" class="svg-text" text-anchor="middle" font-weight="bold">Student</text>
                            <line x1="270" y1="55" x2="270" y2="240" stroke="#999" stroke-dasharray="5,3"/>
                            <rect x="265" y="95" width="10" height="80" fill="#f2cc8f" stroke="#d4a574"/>
                        </g>
                        
                        <!-- Message 1: Question -->
                        <g class="svg-element" data-id="msg1">
                            <line x1="85" y1="85" x2="265" y2="95" stroke="#4a6fa5" stroke-width="2"/>
                            <polygon points="265,95 255,90 255,100" fill="#4a6fa5"/>
                            <text x="170" y="80" class="svg-text" text-anchor="middle">ask("What is X?")</text>
                        </g>
                        
                        <!-- Thinking note -->
                        <g class="svg-element" data-id="note1">
                            <rect x="285" y="110" width="60" height="25" fill="#fffde7" stroke="#ffc107" rx="3"/>
                            <text x="315" y="127" class="svg-text-small" text-anchor="middle">thinking...</text>
                        </g>
                        
                        <!-- Message 2: Answer -->
                        <g class="svg-element" data-id="msg2">
                            <line x1="265" y1="155" x2="85" y2="165" stroke="#81b29a" stroke-width="2" stroke-dasharray="5,3"/>
                            <polygon points="85,165 95,160 95,170" fill="#81b29a"/>
                            <text x="170" y="150" class="svg-text" text-anchor="middle">reply("X is...")</text>
                        </g>
                        
                        <!-- Message 3: Feedback -->
                        <g class="svg-element" data-id="msg3">
                            <line x1="85" y1="195" x2="265" y2="205" stroke="#e07a5f" stroke-width="2"/>
                            <polygon points="265,205 255,200 255,210" fill="#e07a5f"/>
                            <text x="170" y="190" class="svg-text" text-anchor="middle">feedback("Good!")</text>
                        </g>
                    </svg>
                `,
                svgGeneric: `
                    <svg viewBox="0 0 360 260" class="diagram-svg">
                        <g class="svg-element svg-lifeline" data-id="lifeline1">
                            <rect x="20" y="20" width="70" height="35" rx="3"/>
                            <text x="55" y="43" class="svg-text" text-anchor="middle" font-weight="bold">User</text>
                            <line x1="55" y1="55" x2="55" y2="240" stroke="#999" stroke-dasharray="5,3"/>
                            <rect x="50" y="70" width="10" height="30" fill="#f2cc8f" stroke="#d4a574"/>
                        </g>
                        
                        <g class="svg-element svg-lifeline" data-id="lifeline2">
                            <rect x="140" y="20" width="70" height="35" rx="3"/>
                            <text x="175" y="43" class="svg-text" text-anchor="middle" font-weight="bold">System</text>
                            <line x1="175" y1="55" x2="175" y2="240" stroke="#999" stroke-dasharray="5,3"/>
                            <rect x="170" y="90" width="10" height="100" fill="#f2cc8f" stroke="#d4a574"/>
                        </g>
                        
                        <g class="svg-element svg-lifeline" data-id="lifeline3">
                            <rect x="270" y="20" width="70" height="35" rx="3"/>
                            <text x="305" y="43" class="svg-text" text-anchor="middle" font-weight="bold">Database</text>
                            <line x1="305" y1="55" x2="305" y2="240" stroke="#999" stroke-dasharray="5,3"/>
                            <rect x="300" y="115" width="10" height="40" fill="#f2cc8f" stroke="#d4a574"/>
                        </g>
                        
                        <g class="svg-element" data-id="msg1">
                            <line x1="60" y1="80" x2="170" y2="90" stroke="#4a6fa5" stroke-width="2"/>
                            <polygon points="170,90 160,85 160,95" fill="#4a6fa5"/>
                            <text x="110" y="75" class="svg-text" text-anchor="middle">login()</text>
                        </g>
                        
                        <g class="svg-element" data-id="msg2">
                            <line x1="180" y1="120" x2="300" y2="130" stroke="#4a6fa5" stroke-width="2"/>
                            <polygon points="300,130 290,125 290,135" fill="#4a6fa5"/>
                            <text x="235" y="115" class="svg-text" text-anchor="middle">validate()</text>
                        </g>
                        
                        <g class="svg-element" data-id="msg3">
                            <line x1="300" y1="150" x2="180" y2="160" stroke="#81b29a" stroke-width="2" stroke-dasharray="5,3"/>
                            <polygon points="180,160 190,155 190,165" fill="#81b29a"/>
                            <text x="235" y="175" class="svg-text" text-anchor="middle">result</text>
                        </g>
                        
                        <g class="svg-element" data-id="msg4">
                            <line x1="170" y1="190" x2="60" y2="200" stroke="#81b29a" stroke-width="2" stroke-dasharray="5,3"/>
                            <polygon points="60,200 70,195 70,205" fill="#81b29a"/>
                            <text x="110" y="215" class="svg-text" text-anchor="middle">token</text>
                        </g>
                    </svg>
                `
            },
            state: {
                title: "Диаграмма состояний",
                subtitle: "State Machine Diagram",
                level: "Прагматический уровень",
                analogy: {
                    title: "Стадии речевого акта",
                    text: "Подобно тому, как высказывание проходит стадии (намерение → формулировка → произнесение → восприятие), объект переходит между состояниями под влиянием событий."
                },
                examples: {
                    linguistic: {
                        label: "Жизненный цикл вопроса",
                        text: "Open (задан) → Clarified (уточнён) → Answered (получен ответ) → Closed (закрыт). Переходы: clarify(), answer(), close()"
                    },
                    generic: {
                        label: "Статус заказа",
                        text: "New → Processing → Shipped → Delivered. Переходы по событиям: pay(), ship(), deliver()"
                    }
                },
                elements: [
                    { id: "state-init", tooltip: "Начальное состояние — точка входа", step: 1 },
                    { id: "state1", tooltip: "Состояние 'Open' — вопрос задан", step: 2 },
                    { id: "state2", tooltip: "Состояние 'Clarified' — вопрос уточнён", step: 3 },
                    { id: "state3", tooltip: "Состояние 'Answered' — ответ получен", step: 4 },
                    { id: "state-final", tooltip: "Конечное состояние — диалог завершён", step: 5 }
                ],
                svgLinguistic: `
                    <svg viewBox="0 0 380 200" class="diagram-svg">
                        <!-- Initial state -->
                        <g class="svg-element" data-id="state-init">
                            <circle cx="30" cy="100" r="10" fill="#333"/>
                        </g>
                        
                        <!-- Arrow to Open -->
                        <line x1="40" y1="100" x2="65" y2="100" class="svg-arrow"/>
                        <polygon points="65,100 58,96 58,104" class="svg-arrow-head"/>
                        
                        <!-- Open state -->
                        <g class="svg-element svg-state" data-id="state1">
                            <rect x="70" y="75" width="70" height="50" rx="10"/>
                            <text x="105" y="105" class="svg-text" text-anchor="middle" font-weight="bold">Open</text>
                        </g>
                        
                        <!-- Arrow + label -->
                        <g class="svg-element" data-id="trans1">
                            <line x1="140" y1="100" x2="165" y2="100" class="svg-arrow"/>
                            <polygon points="165,100 158,96 158,104" class="svg-arrow-head"/>
                            <text x="152" y="90" class="svg-text-small" text-anchor="middle">clarify()</text>
                        </g>
                        
                        <!-- Clarified state -->
                        <g class="svg-element svg-state" data-id="state2">
                            <rect x="170" y="75" width="70" height="50" rx="10"/>
                            <text x="205" y="105" class="svg-text" text-anchor="middle" font-weight="bold">Clarified</text>
                        </g>
                        
                        <!-- Arrow + label -->
                        <g class="svg-element" data-id="trans2">
                            <line x1="240" y1="100" x2="265" y2="100" class="svg-arrow"/>
                            <polygon points="265,100 258,96 258,104" class="svg-arrow-head"/>
                            <text x="252" y="90" class="svg-text-small" text-anchor="middle">answer()</text>
                        </g>
                        
                        <!-- Answered state -->
                        <g class="svg-element svg-state" data-id="state3">
                            <rect x="270" y="75" width="70" height="50" rx="10"/>
                            <text x="305" y="105" class="svg-text" text-anchor="middle" font-weight="bold">Answered</text>
                        </g>
                        
                        <!-- Arrow to final -->
                        <g class="svg-element" data-id="trans3">
                            <path d="M305 125 Q305 160 340 160 L355 160" fill="none" class="svg-arrow"/>
                            <polygon points="355,160 348,156 348,164" class="svg-arrow-head"/>
                            <text x="330" y="175" class="svg-text-small">close()</text>
                        </g>
                        
                        <!-- Final state -->
                        <g class="svg-element" data-id="state-final">
                            <circle cx="365" cy="160" r="12" fill="none" stroke="#333" stroke-width="2"/>
                            <circle cx="365" cy="160" r="8" fill="#333"/>
                        </g>
                        
                        <!-- Self-loop on Open -->
                        <g class="svg-element" data-id="trans4">
                            <path d="M105 75 Q105 45 130 55 Q140 75 140 90" fill="none" class="svg-arrow" stroke-dasharray="4,2"/>
                            <text x="125" y="40" class="svg-text-small">rephrase()</text>
                        </g>
                    </svg>
                `,
                svgGeneric: `
                    <svg viewBox="0 0 380 200" class="diagram-svg">
                        <g class="svg-element" data-id="state-init">
                            <circle cx="30" cy="100" r="10" fill="#333"/>
                        </g>
                        
                        <line x1="40" y1="100" x2="65" y2="100" class="svg-arrow"/>
                        <polygon points="65,100 58,96 58,104" class="svg-arrow-head"/>
                        
                        <g class="svg-element svg-state" data-id="state1">
                            <rect x="70" y="75" width="70" height="50" rx="10"/>
                            <text x="105" y="105" class="svg-text" text-anchor="middle" font-weight="bold">New</text>
                        </g>
                        
                        <g class="svg-element" data-id="trans1">
                            <line x1="140" y1="100" x2="165" y2="100" class="svg-arrow"/>
                            <polygon points="165,100 158,96 158,104" class="svg-arrow-head"/>
                            <text x="152" y="90" class="svg-text-small" text-anchor="middle">pay()</text>
                        </g>
                        
                        <g class="svg-element svg-state" data-id="state2">
                            <rect x="170" y="75" width="70" height="50" rx="10"/>
                            <text x="205" y="100" class="svg-text" text-anchor="middle" font-weight="bold">Proces-</text>
                            <text x="205" y="112" class="svg-text" text-anchor="middle" font-weight="bold">sing</text>
                        </g>
                        
                        <g class="svg-element" data-id="trans2">
                            <line x1="240" y1="100" x2="265" y2="100" class="svg-arrow"/>
                            <polygon points="265,100 258,96 258,104" class="svg-arrow-head"/>
                            <text x="252" y="90" class="svg-text-small" text-anchor="middle">ship()</text>
                        </g>
                        
                        <g class="svg-element svg-state" data-id="state3">
                            <rect x="270" y="75" width="70" height="50" rx="10"/>
                            <text x="305" y="105" class="svg-text" text-anchor="middle" font-weight="bold">Shipped</text>
                        </g>
                        
                        <g class="svg-element" data-id="trans3">
                            <path d="M305 125 Q305 160 340 160 L355 160" fill="none" class="svg-arrow"/>
                            <polygon points="355,160 348,156 348,164" class="svg-arrow-head"/>
                            <text x="325" y="175" class="svg-text-small">deliver()</text>
                        </g>
                        
                        <g class="svg-element" data-id="state-final">
                            <circle cx="365" cy="160" r="12" fill="none" stroke="#333" stroke-width="2"/>
                            <circle cx="365" cy="160" r="8" fill="#333"/>
                        </g>
                    </svg>
                `
            },
            activity: {
                title: "Диаграмма деятельности",
                subtitle: "Activity Diagram",
                level: "Процедурный уровень",
                analogy: {
                    title: "Алгоритм обучения / Игра",
                    text: "Как методический сценарий урока или правила языковой игры описывают последовательность действий с ветвлениями и параллелизмом, так Activity Diagram моделирует бизнес-процессы."
                },
                examples: {
                    linguistic: {
                        label: "Процесс выполнения упражнения",
                        text: "Начало → Прочитать задание → [Понятно?] → Да: Выполнить → Проверить → [Верно?] → Готово / Нет: Исправить"
                    },
                    generic: {
                        label: "Обработка заказа",
                        text: "Получить заказ → Проверить наличие → [Есть?] → Упаковать → Отправить → Конец"
                    }
                },
                elements: [
                    { id: "act-start", tooltip: "Начальный узел — старт процесса", step: 1 },
                    { id: "act1", tooltip: "Действие: чтение задания", step: 2 },
                    { id: "decision1", tooltip: "Ветвление: проверка понимания", step: 3 },
                    { id: "act2", tooltip: "Действие: выполнение упражнения", step: 4 },
                    { id: "act3", tooltip: "Действие: самопроверка", step: 5 },
                    { id: "act-end", tooltip: "Конечный узел — завершение", step: 6 }
                ],
                svgLinguistic: `
                    <svg viewBox="0 0 350 280" class="diagram-svg">
                        <!-- Start -->
                        <g class="svg-element" data-id="act-start">
                            <circle cx="175" cy="20" r="10" fill="#333"/>
                        </g>
                        
                        <line x1="175" y1="30" x2="175" y2="45" class="svg-arrow"/>
                        <polygon points="175,45 171,38 179,38" class="svg-arrow-head"/>
                        
                        <!-- Read Task -->
                        <g class="svg-element svg-activity" data-id="act1">
                            <rect x="110" y="50" width="130" height="35" rx="17"/>
                            <text x="175" y="72" class="svg-text" text-anchor="middle">Read Task</text>
                        </g>
                        
                        <line x1="175" y1="85" x2="175" y2="100" class="svg-arrow"/>
                        
                        <!-- Decision: Understood? -->
                        <g class="svg-element svg-decision" data-id="decision1">
                            <polygon points="175,105 210,130 175,155 140,130"/>
                            <text x="175" y="134" class="svg-text-small" text-anchor="middle">Clear?</text>
                        </g>
                        
                        <!-- No branch - Ask for help -->
                        <g class="svg-element" data-id="branch-no">
                            <line x1="140" y1="130" x2="60" y2="130" class="svg-arrow"/>
                            <text x="100" y="122" class="svg-text-small">[no]</text>
                            <rect x="20" y="112" width="75" height="35" rx="17" class="svg-activity" fill="#e1f5fe" stroke="#03a9f4"/>
                            <text x="57" y="134" class="svg-text" text-anchor="middle">Ask Help</text>
                            <line x1="57" y1="147" x2="57" y2="200" class="svg-arrow"/>
                            <line x1="57" y1="200" x2="140" y2="200" class="svg-arrow"/>
                        </g>
                        
                        <!-- Yes branch -->
                        <line x1="175" y1="155" x2="175" y2="170" class="svg-arrow"/>
                        <text x="185" y="165" class="svg-text-small">[yes]</text>
                        
                        <!-- Do Exercise -->
                        <g class="svg-element svg-activity" data-id="act2">
                            <rect x="110" y="175" width="130" height="35" rx="17"/>
                            <text x="175" y="197" class="svg-text" text-anchor="middle">Do Exercise</text>
                        </g>
                        
                        <line x1="175" y1="210" x2="175" y2="225" class="svg-arrow"/>
                        
                        <!-- Check -->
                        <g class="svg-element svg-activity" data-id="act3">
                            <rect x="125" y="230" width="100" height="30" rx="15"/>
                            <text x="175" y="250" class="svg-text" text-anchor="middle">Self-Check</text>
                        </g>
                        
                        <!-- End -->
                        <g class="svg-element" data-id="act-end">
                            <line x1="225" y1="245" x2="290" y2="245" class="svg-arrow"/>
                            <circle cx="305" cy="245" r="12" fill="none" stroke="#333" stroke-width="2"/>
                            <circle cx="305" cy="245" r="7" fill="#333"/>
                        </g>
                        
                        <!-- Loop back -->
                        <g class="svg-element" data-id="loop">
                            <path d="M240 200 Q280 200 280 130 Q280 70 240 70" fill="none" class="svg-arrow" stroke-dasharray="4,2"/>
                            <polygon points="240,70 248,66 248,74" class="svg-arrow-head"/>
                            <text x="290" y="140" class="svg-text-small">[retry]</text>
                        </g>
                    </svg>
                `,
                svgGeneric: `
                    <svg viewBox="0 0 350 280" class="diagram-svg">
                        <g class="svg-element" data-id="act-start">
                            <circle cx="175" cy="20" r="10" fill="#333"/>
                        </g>
                        
                        <line x1="175" y1="30" x2="175" y2="45" class="svg-arrow"/>
                        
                        <g class="svg-element svg-activity" data-id="act1">
                            <rect x="110" y="50" width="130" height="35" rx="17"/>
                            <text x="175" y="72" class="svg-text" text-anchor="middle">Receive Order</text>
                        </g>
                        
                        <line x1="175" y1="85" x2="175" y2="100" class="svg-arrow"/>
                        
                        <g class="svg-element svg-decision" data-id="decision1">
                            <polygon points="175,105 210,130 175,155 140,130"/>
                            <text x="175" y="134" class="svg-text-small" text-anchor="middle">In Stock?</text>
                        </g>
                        
                        <g class="svg-element" data-id="branch-no">
                            <line x1="140" y1="130" x2="60" y2="130" class="svg-arrow"/>
                            <text x="100" y="122" class="svg-text-small">[no]</text>
                            <rect x="15" y="112" width="80" height="35" rx="17" class="svg-activity" fill="#e1f5fe" stroke="#03a9f4"/>
                            <text x="55" y="134" class="svg-text" text-anchor="middle">Backorder</text>
                        </g>
                        
                        <line x1="175" y1="155" x2="175" y2="175" class="svg-arrow"/>
                        <text x="185" y="165" class="svg-text-small">[yes]</text>
                        
                        <g class="svg-element svg-activity" data-id="act2">
                            <rect x="125" y="180" width="100" height="30" rx="15"/>
                            <text x="175" y="200" class="svg-text" text-anchor="middle">Pack Items</text>
                        </g>
                        
                        <line x1="175" y1="210" x2="175" y2="225" class="svg-arrow"/>
                        
                        <g class="svg-element svg-activity" data-id="act3">
                            <rect x="125" y="230" width="100" height="30" rx="15"/>
                            <text x="175" y="250" class="svg-text" text-anchor="middle">Ship Order</text>
                        </g>
                        
                        <g class="svg-element" data-id="act-end">
                            <line x1="225" y1="245" x2="290" y2="245" class="svg-arrow"/>
                            <circle cx="305" cy="245" r="12" fill="none" stroke="#333" stroke-width="2"/>
                            <circle cx="305" cy="245" r="7" fill="#333"/>
                        </g>
                    </svg>
                `
            }
        };

        // ============ STATE ============
        const state = {
            currentExample: {}, // { diagramId: 'linguistic' | 'generic' }
            currentStep: {},    // { diagramId: stepNumber }
            maxSteps: {}        // { diagramId: maxStepNumber }
        };

        // Initialize state
        Object.keys(diagramsData).forEach(key => {
            state.currentExample[key] = 'linguistic';
            state.currentStep[key] = 0;
            state.maxSteps[key] = diagramsData[key].elements.length;
        });

        // ============ RENDER ============
        function renderCards() {
            const container = document.getElementById('cardsContainer');
            container.innerHTML = '';

            Object.entries(diagramsData).forEach(([key, data]) => {
                const card = createCard(key, data);
                container.appendChild(card);
            });
        }

        function createCard(key, data) {
            const card = document.createElement('div');
            card.className = 'card';
            card.dataset.diagram = key;

            const exampleType = state.currentExample[key];
            const currentSvg = exampleType === 'linguistic' ? data.svgLinguistic : data.svgGeneric;
            const currentExample = data.examples[exampleType];

            card.innerHTML = `
                <div class="card-header">
                    <div>
                        <div class="card-title">${data.title}</div>
                        <div class="card-subtitle">${data.subtitle} • ${data.level}</div>
                    </div>
                    <div class="example-toggle">
                        <button class="toggle-btn ${exampleType === 'linguistic' ? 'active' : ''}" 
                                data-type="linguistic" data-diagram="${key}">
                            Лингв.
                        </button>
                        <button class="toggle-btn ${exampleType === 'generic' ? 'active' : ''}" 
                                data-type="generic" data-diagram="${key}">
                            Общий
                        </button>
                    </div>
                </div>
                
                <div class="svg-container" data-diagram="${key}">
                    ${currentSvg}
                </div>
                
                <div class="info-panel">
                    <div class="analogy-box">
                        <h4>${data.analogy.title}</h4>
                        <p>${data.analogy.text}</p>
                    </div>
                    
                    <div class="example-box">
                        <span class="label">${currentExample.label}:</span>
                        ${currentExample.text}
                    </div>
                    
                    <div class="step-controls">
                        <button class="step-btn" data-action="prev" data-diagram="${key}">← Prev</button>
                        <div class="step-indicator">
                            ${data.elements.map((_, i) => 
                                `<span class="step-dot ${i < state.currentStep[key] ? 'active' : ''}" 
                                       data-step="${i + 1}"></span>`
                            ).join('')}
                        </div>
                        <button class="step-btn" data-action="next" data-diagram="${key}">Next →</button>
                    </div>
                </div>
            `;

            return card;
        }

        // ============ EVENT HANDLERS ============
        function setupEventDelegation() {
            const container = document.getElementById('cardsContainer');
            const tooltip = document.getElementById('tooltip');

            // Toggle example type
            container.addEventListener('click', (e) => {
                const toggleBtn = e.target.closest('.toggle-btn');
                if (toggleBtn) {
                    const diagram = toggleBtn.dataset.diagram;
                    const type = toggleBtn.dataset.type;
                    state.currentExample[diagram] = type;
                    state.currentStep[diagram] = 0;
                    renderCards();
                    setupEventDelegation();
                }

                // Step navigation
                const stepBtn = e.target.closest('.step-btn');
                if (stepBtn) {
                    const diagram = stepBtn.dataset.diagram;
                    const action = stepBtn.dataset.action;
                    
                    if (action === 'next' && state.currentStep[diagram] < state.maxSteps[diagram]) {
                        state.currentStep[diagram]++;
                    } else if (action === 'prev' && state.currentStep[diagram] > 0) {
                        state.currentStep[diagram]--;
                    }
                    
                    updateHighlights(diagram);
                    updateStepIndicator(diagram);
                }
            });

            // Hover tooltips for SVG elements
            container.addEventListener('mouseover', (e) => {
                const svgElement = e.target.closest('.svg-element');
                if (svgElement) {
                    const svgContainer = svgElement.closest('.svg-container');
                    const diagram = svgContainer.dataset.diagram;
                    const elementId = svgElement.dataset.id;
                    
                    const elementData = diagramsData[diagram].elements.find(el => el.id === elementId);
                    if (elementData) {
                        showTooltip(e, elementData.tooltip);
                        svgElement.classList.add('highlighted');
                    }
                }
            });

            container.addEventListener('mouseout', (e) => {
                const svgElement = e.target.closest('.svg-element');
                if (svgElement) {
                    hideTooltip();
                    // Don't remove highlight if it's the current step
                    const svgContainer = svgElement.closest('.svg-container');
                    const diagram = svgContainer.dataset.diagram;
                    const elementId = svgElement.dataset.id;
                    const elementData = diagramsData[diagram].elements.find(el => el.id === elementId);
                    
                    if (!elementData || elementData.step !== state.currentStep[diagram]) {
                        svgElement.classList.remove('highlighted');
                    }
                }
            });

            // Mouse move for tooltip positioning
            container.addEventListener('mousemove', (e) => {
                if (tooltip.classList.contains('visible')) {
                    positionTooltip(e);
                }
            });
        }

        function showTooltip(e, text) {
            const tooltip = document.getElementById('tooltip');
            tooltip.textContent = text;
            tooltip.classList.add('visible');
            positionTooltip(e);
        }

        function hideTooltip() {
            const tooltip = document.getElementById('tooltip');
            tooltip.classList.remove('visible');
        }

        function positionTooltip(e) {
            const tooltip = document.getElementById('tooltip');
            const rect = tooltip.getBoundingClientRect();
            let x = e.clientX - rect.width / 2;
            let y = e.clientY - rect.height - 15;
            
            // Keep within viewport
            x = Math.max(10, Math.min(x, window.innerWidth - rect.width - 10));
            y = Math.max(10, y);
            
            tooltip.style.left = x + 'px';
            tooltip.style.top = y + 'px';
        }

        function updateHighlights(diagram) {
            const card = document.querySelector(`[data-diagram="${diagram}"]`);
            const svgContainer = card.querySelector('.svg-container');
            const elements = svgContainer.querySelectorAll('.svg-element');
            const currentStep = state.currentStep[diagram];
            
            elements.forEach(el => {
                el.classList.remove('highlighted');
                const elementId = el.dataset.id;
                const elementData = diagramsData[diagram].elements.find(e => e.id === elementId);
                
                if (elementData && elementData.step === currentStep) {
                    el.classList.add('highlighted');
                    
                    // Show tooltip for current step element
                    if (currentStep > 0) {
                        const tooltip = document.getElementById('tooltip');
                        tooltip.textContent = elementData.tooltip;
                        const rect = el.getBoundingClientRect();
                        tooltip.style.left = (rect.left + rect.width / 2 - 100) + 'px';
                        tooltip.style.top = (rect.top - 50) + 'px';
                        tooltip.classList.add('visible');
                        
                        setTimeout(() => tooltip.classList.remove('visible'), 2000);
                    }
                }
            });
        }

        function updateStepIndicator(diagram) {
            const card = document.querySelector(`[data-diagram="${diagram}"]`);
            const dots = card.querySelectorAll('.step-dot');
            const currentStep = state.currentStep[diagram];
            
            dots.forEach((dot, i) => {
                dot.classList.toggle('active', i < currentStep);
            });
            
            // Update button states
            const prevBtn = card.querySelector('[data-action="prev"]');
            const nextBtn = card.querySelector('[data-action="next"]');
            
            prevBtn.disabled = currentStep === 0;
            nextBtn.disabled = currentStep >= state.maxSteps[diagram];
        }

        // ============ INIT ============
        document.addEventListener('DOMContentLoaded', () => {
            renderCards();
            setupEventDelegation();
        });
    </script>
</body>
</html>